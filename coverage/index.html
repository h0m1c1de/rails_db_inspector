<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Rails db inspector</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.2/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.2/favicon_green.png" />
  </head>

  <body data-branch-coverage=true>
    <div id="loading">
      <img src="./assets/0.13.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2026-02-24T08:09:51-05:00">2026-02-24T08:09:51-05:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="green">
  98.46%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         14.28
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>13</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1036</b> relevant lines,
    <span class="green"><b>1020</b> lines covered</span> and
    <span class="red"><b>16</b> lines missed. </span>
    (<span class="green">
  98.46%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>541</b> total branches, </span>
      <span class="green"><b>464</b> branches covered</span> and
      <span class="red"><b>77</b> branches missed.</span>
      (<span class="yellow">
  85.77%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b48c39197ff8d9006e089eee3428013e8ef446f2" class="src_link" title="app/helpers/rails_db_inspector/application_helper.rb">app/helpers/rails_db_inspector/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">274</td>
            <td class="cell--number">125</td>
            <td class="cell--number">125</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.10</td>
            
              <td class="green strong cell--number t-file__branch-coverage">95.31 %</td>
              <td class="cell--number">64</td>
              <td class="cell--number">61</td>
              <td class="cell--number">3</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#85fc28e60059ab1b47fae25dd64c568ba7b86ac3" class="src_link" title="app/helpers/rails_db_inspector/plan_renderer.rb">app/helpers/rails_db_inspector/plan_renderer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.66 %</td>
            <td class="cell--number">887</td>
            <td class="cell--number">385</td>
            <td class="cell--number">376</td>
            <td class="cell--number">9</td>
            <td class="cell--number">13.28</td>
            
              <td class="yellow strong cell--number t-file__branch-coverage">83.27 %</td>
              <td class="cell--number">275</td>
              <td class="cell--number">229</td>
              <td class="cell--number">46</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac0183ac1c8352136409505f9d21f1c9827258cb" class="src_link" title="lib/rails_db_inspector.rb">lib/rails_db_inspector.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">26</td>
            <td class="cell--number">17</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">7.12</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7493d10db95736c687e1ae7200e48254cf75b8c1" class="src_link" title="lib/rails_db_inspector/configuration.rb">lib/rails_db_inspector/configuration.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">11</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17.36</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ea611bdf30362a1ae9ac30f7296f3a892113e8be" class="src_link" title="lib/rails_db_inspector/dev_widget_middleware.rb">lib/rails_db_inspector/dev_widget_middleware.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">145</td>
            <td class="cell--number">33</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.76</td>
            
              <td class="yellow strong cell--number t-file__branch-coverage">88.89 %</td>
              <td class="cell--number">18</td>
              <td class="cell--number">16</td>
              <td class="cell--number">2</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1a9e44810fe1f554cea0c44aebc019e646a8d684" class="src_link" title="lib/rails_db_inspector/engine.rb">lib/rails_db_inspector/engine.rb</a></td>
            <td class="red strong cell--number t-file__coverage">50.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">12</td>
            <td class="cell--number">6</td>
            <td class="cell--number">6</td>
            <td class="cell--number">0.50</td>
            
              <td class="red strong cell--number t-file__branch-coverage">0.00 %</td>
              <td class="cell--number">8</td>
              <td class="cell--number">0</td>
              <td class="cell--number">8</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#bd4298eef5a8f0997d3cf62188365097c7a3512a" class="src_link" title="lib/rails_db_inspector/explain.rb">lib/rails_db_inspector/explain.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">29</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.14</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">6</td>
              <td class="cell--number">6</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#26844e7350ab7d528c983242fb9b656d5d71f3ea" class="src_link" title="lib/rails_db_inspector/explain/my_sql.rb">lib/rails_db_inspector/explain/my_sql.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">13</td>
            <td class="cell--number">13</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.69</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1ebfc5f22ab7c0dc89fa422c2c79186020722993" class="src_link" title="lib/rails_db_inspector/explain/postgres.rb">lib/rails_db_inspector/explain/postgres.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">32</td>
            <td class="cell--number">16</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.25</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">4</td>
              <td class="cell--number">4</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#afadfd196b69898674ba600ada8304bccb6f0f89" class="src_link" title="lib/rails_db_inspector/explain/sqlite.rb">lib/rails_db_inspector/explain/sqlite.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">37</td>
            <td class="cell--number">15</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3ba9c5a49c34030a58befb1da20f29939e3c1343" class="src_link" title="lib/rails_db_inspector/query_store.rb">lib/rails_db_inspector/query_store.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">89</td>
            <td class="cell--number">42</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0</td>
            <td class="cell--number">36.14</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">12</td>
              <td class="cell--number">12</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#672ba5102cbe7570b6ea0a714af34096094c6ccf" class="src_link" title="lib/rails_db_inspector/schema_inspector.rb">lib/rails_db_inspector/schema_inspector.rb</a></td>
            <td class="green strong cell--number t-file__coverage">99.70 %</td>
            <td class="cell--number">776</td>
            <td class="cell--number">334</td>
            <td class="cell--number">333</td>
            <td class="cell--number">1</td>
            <td class="cell--number">20.00</td>
            
              <td class="yellow strong cell--number t-file__branch-coverage">87.50 %</td>
              <td class="cell--number">136</td>
              <td class="cell--number">119</td>
              <td class="cell--number">17</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#33c235cfa4091352ae218ce1f320386b73ca9125" class="src_link" title="lib/rails_db_inspector/sql_subscriber.rb">lib/rails_db_inspector/sql_subscriber.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">42</td>
            <td class="cell--number">19</td>
            <td class="cell--number">19</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.37</td>
            
              <td class="green strong cell--number t-file__branch-coverage">92.86 %</td>
              <td class="cell--number">14</td>
              <td class="cell--number">13</td>
              <td class="cell--number">1</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.2<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="b48c39197ff8d9006e089eee3428013e8ef446f2">
  <div class="header">
    <h3>app/helpers/rails_db_inspector/application_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  95.31%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>125</b> relevant lines.
      <span class="green"><b>125</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>64</b> total branches, </span>
          <span class="green"><b>61</b> branches covered</span> and
          <span class="red"><b>3</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;plan_renderer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def render_postgres_plan(plan_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      renderer = RailsDbInspector::ApplicationHelper::PostgresPlanRenderer.new(plan_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      (renderer.render_summary + renderer.render_tree).html_safe</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def render_query_type(query)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="11">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      sql = query.sql.downcase.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">      # Determine the primary operation</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="14">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      operation = case sql</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
                <span class="hits" title="when branch hit 6 times">
                  when: 6
                </span>
              
            

            <code class="ruby">      when /^select\b/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="16">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        &quot;SELECT&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /^insert\b/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;INSERT&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /^update\b/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;UPDATE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /^delete\b/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;DELETE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /^with\b/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;CTE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;OTHER&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">      # Add complexity indicators for SELECT queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="30">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      complexity_hints = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="32">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">      if operation == &quot;SELECT&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="33">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        complexity_hints &lt;&lt; &quot;JOIN&quot; if sql.include?(&quot; join &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="34">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        complexity_hints &lt;&lt; &quot;SUBQUERY&quot; if sql.include?(&quot;(select&quot;) || sql.include?(&quot;( select&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="35">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        complexity_hints &lt;&lt; &quot;AGGREGATE&quot; if sql.match?(/\b(count|sum|avg|max|min|group by)\b/)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="36">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        complexity_hints &lt;&lt; &quot;ORDER BY&quot; if sql.include?(&quot; order by &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="37">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        complexity_hints &lt;&lt; &quot;WINDOW&quot; if sql.include?(&quot; over(&quot;) || sql.include?(&quot; over (&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">      # Render the operation with complexity hints</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="41">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      result_html = &quot;&lt;span class=\&quot;inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800\&quot;&gt;#{operation}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="43">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      complexity_hints.each do |hint|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="44">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        case hint</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">        when &quot;JOIN&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          result_html += &quot; &lt;span class=\&quot;inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-100 text-blue-800\&quot;&gt;#{hint}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            
              
                <span class="hits" title="when branch hit 2 times">
                  when: 2
                </span>
              
            

            <code class="ruby">        when &quot;AGGREGATE&quot;, &quot;WINDOW&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="48">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          result_html += &quot; &lt;span class=\&quot;inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-yellow-100 text-yellow-800\&quot;&gt;#{hint}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">        when &quot;SUBQUERY&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          result_html += &quot; &lt;span class=\&quot;inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-red-100 text-red-800\&quot;&gt;#{hint}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          result_html += &quot; &lt;span class=\&quot;inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-green-100 text-green-800\&quot;&gt;#{hint}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="56">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      result_html.html_safe</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def group_queries_by_action(queries)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="60">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      return [] if queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="62">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      groups = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="63">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      current_group = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="65">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      queries.each do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="66">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        controller_action = extract_controller_action_from_sql(query)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            
              
            

            <code class="ruby">        # Start a new group if:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby">        # 1. No current group</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby">        # 2. Different controller/action</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby">        # 3. Time gap of more than 10 seconds from the last query in the group</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="72">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        if current_group.nil? ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">           current_group[:action] != controller_action ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby">           time_gap_too_large?(query, current_group[:queries].last, 10.0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            
              
            

            <code class="ruby">          current_group = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="77">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">            action: controller_action,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby">            queries: [],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            
              
            

            <code class="ruby">            start_time: query.timestamp,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby">            request_type: determine_request_type_from_action(controller_action)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="82">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">          groups &lt;&lt; current_group</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="85">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        current_group[:queries] &lt;&lt; query</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="88">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      groups</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def detect_n_plus_one(queries)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="92">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">      return [] if queries.length &lt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            
              
            

            <code class="ruby">      # Normalize queries by replacing literal values with placeholders</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="95">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      normalized = queries.map do |q|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="97">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">          query: q,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            
              
            

            <code class="ruby">          normalized: normalize_sql(q.sql)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            
              
            

            <code class="ruby">      # Group by normalized SQL</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="103">
            
              <span class="hits">33</span>
            

            
              
            

            <code class="ruby">      groups = normalized.group_by { |entry| entry[:normalized] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            
              
            

            <code class="ruby">      # Find N+1 patterns: same normalized query appearing 3+ times</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="106">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      n_plus_ones = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="107">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      groups.each do |normalized_sql, entries|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="108">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        next if entries.length &lt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="6" data-linenumber="109">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        next if normalized_sql.strip.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            
              
            

            <code class="ruby">        # Skip schema/transaction queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="112">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        next if normalized_sql =~ /\A(BEGIN|COMMIT|ROLLBACK|SET|SHOW)\b/i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="114">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        sample_query = entries.first[:query]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="115">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">        total_duration = entries.sum { |e| e[:query].duration_ms }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby">        # Try to extract the table name</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="5" data-linenumber="118">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">        table = normalized_sql.match(/FROM\s+&quot;?(\w+)&quot;?/i)&amp;.captures&amp;.first || &quot;unknown&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="120">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        n_plus_ones &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            
              
            

            <code class="ruby">          normalized_sql: normalized_sql,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby">          count: entries.length,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="123">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">          queries: entries.map { |e| e[:query] },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            
              
            

            <code class="ruby">          sample: sample_query,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            
              
            

            <code class="ruby">          total_duration_ms: total_duration,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            
              
            

            <code class="ruby">          table: table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            
              
            

            <code class="ruby">          name: sample_query.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            
              
            

            <code class="ruby">      # Sort by count descending (worst offenders first)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="132">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      n_plus_ones.sort_by { |n| -n[:count] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="135">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="137">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def normalize_sql(sql)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="138">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized = sql.dup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby">      # Remove SQL comments like /*...*/ (Rails marginal annotations)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="140">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.gsub!(/\/\*.*?\*\//m, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            
              
            

            <code class="ruby">      # Replace string literals &#39;value&#39; with ?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="142">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.gsub!(/&#39;[^&#39;]*&#39;/, &quot;?&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            
              
            

            <code class="ruby">      # Replace numeric literals (integers and floats)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="144">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.gsub!(/\b\d+(\.\d+)?\b/, &quot;?&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            
              
            

            <code class="ruby">      # Replace $1, $2 style bind params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="146">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.gsub!(/\$\d+/, &quot;?&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            
              
            

            <code class="ruby">      # Collapse whitespace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="148">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.gsub!(/\s+/, &quot; &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="149">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      normalized.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="152">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def extract_controller_action_from_sql(query)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="153">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">      sql = query.sql.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            
              
            

            <code class="ruby">      # Look for controller and action in SQL comments</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="156">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      if match = sql.match(/\/\*.*?controller=&#39;([^&#39;]+)&#39;.*?action=&#39;([^&#39;]+)&#39;.*?\*\//)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="157">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        controller = match[1]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="158">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        action = match[2]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            
              
            

            <code class="ruby">        # Handle namespaced controllers properly</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="161">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        if controller.include?(&quot;/&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">          # Convert api/users to Api::UsersController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="163">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          controller_parts = controller.split(&quot;/&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="164">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          namespaced_controller = controller_parts.map(&amp;:camelize).join(&quot;::&quot;) + &quot;Controller&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="166">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">          namespaced_controller = &quot;#{controller.camelize}Controller&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="169">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        return &quot;#{namespaced_controller}##{action}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            
              
            

            <code class="ruby">      # Fallback to query name if no controller/action found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="173">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      query.name.to_s.presence || &quot;Unknown Query&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="176">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def determine_request_type_from_action(action_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="177">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">      case action_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /API::|Api::|\/api\//i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="179">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        :api</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            
              
            

            <code class="ruby">      when /Controller#/</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            
              
                <span class="hits" title="when branch hit 8 times">
                  when: 8
                </span>
              
            

            <code class="ruby">        # Check if it looks like an API endpoint based on common patterns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="182">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        if action_name.match(/(show|index|create|update|destroy)/) &amp;&amp;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            
              
            

            <code class="ruby">           !action_name.match(/(new|edit)/)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
            

            <code class="ruby">          # Could be API if no render actions (new/edit are typically web-only)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="185">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          :web_or_api</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="187">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          :web_request</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            
              
                <span class="hits" title="when branch hit 4 times">
                  when: 4
                </span>
              
            

            <code class="ruby">      when /Load|Create|Update|Delete|Destroy/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="190">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">        :model_operation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            
              
                <span class="hits" title="when branch hit 2 times">
                  when: 2
                </span>
              
            

            <code class="ruby">      when /Schema|Migration/i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="192">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        :schema</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="194">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        :other</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="198">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def group_icon(request_type)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="199">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      case request_type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when :api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="201">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when :web_request</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="203">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when :web_or_api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="205">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;  # Mixed/ambiguous</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when :model_operation</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="207">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when :schema</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="209">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="211">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="215">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def time_gap_too_large?(current_query, last_query, gap_seconds = 5.0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="216">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      return false if last_query.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="218">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      current_time = parse_timestamp(current_query.timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="219">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      last_time = parse_timestamp(last_query.timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="221">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      (current_time - last_time).abs &gt; gap_seconds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="224">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def parse_timestamp(timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="225">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">      case timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            
              
                <span class="hits" title="when branch hit 13 times">
                  when: 13
                </span>
              
            

            <code class="ruby">      when Time</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="227">
            
              <span class="hits">13</span>
            

            
              
            

            <code class="ruby">        timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when Numeric</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="229">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        Time.at(timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="231">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        Time.parse(timestamp.to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            
              
            

            <code class="ruby">    rescue</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="234">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      Time.now</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="237">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def format_group_time_range(group)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="238">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">      return &quot;&quot; if group[:queries].empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="240">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      start_time = parse_timestamp(group[:start_time])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="241">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      end_time = parse_timestamp(group[:queries].last.timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="243">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">      if (end_time - start_time) &lt; 1.0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="244">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        start_time.strftime(&quot;%H:%M:%S&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="246">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;#{start_time.strftime(&#39;%H:%M:%S&#39;)} - #{end_time.strftime(&#39;%H:%M:%S&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            
              
            

            <code class="ruby">    # JSON serialization helpers for schema visualization</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="251">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def schema_to_json(schema)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="252">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      result = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="253">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      schema.each do |table_name, info|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="254">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        result[table_name] = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="255">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          columns: info[:columns].map { |c| { name: c[:name], type: c[:type], nullable: c[:nullable], default: c[:default] } },</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="256">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          indexes: info[:indexes].map { |i| { name: i[:name], columns: i[:columns], unique: i[:unique] } },</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="257">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          foreign_keys: info[:foreign_keys].map { |fk| { column: fk[:column], to_table: fk[:to_table], primary_key: fk[:primary_key] } },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            
              
            

            <code class="ruby">          primary_key: info[:primary_key],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            
              
            

            <code class="ruby">          row_count: info[:row_count],</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="260">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          associations: (info[:associations] || []).map { |a| { name: a[:name], macro: a[:macro], target_table: a[:target_table], foreign_key: a[:foreign_key], through: a[:through] } },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            
              
            

            <code class="ruby">          missing_indexes: info[:missing_indexes] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="262">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          polymorphic_columns: (info[:polymorphic_columns] || []).map { |p| { name: p[:name], type_column: p[:type_column], id_column: p[:id_column] } }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="265">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      result.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="268">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def relationships_to_json(relationships)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="269">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      relationships.map do |r|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="270">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        { from_table: r[:from_table], from_column: r[:from_column], to_table: r[:to_table], to_column: r[:to_column], type: r[:type].to_s }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            
              
            

            <code class="ruby">      end.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="273">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="85fc28e60059ab1b47fae25dd64c568ba7b86ac3">
  <div class="header">
    <h3>app/helpers/rails_db_inspector/plan_renderer.rb</h3>
    <h4>
      <span class="green">
  97.66%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="yellow">
  83.27%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>385</b> relevant lines.
      <span class="green"><b>376</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>275</b> total branches, </span>
          <span class="green"><b>229</b> branches covered</span> and
          <span class="red"><b>46</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;securerandom&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;erb&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class PostgresPlanRenderer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def initialize(plan_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="10">
            
              <span class="hits">78</span>
            

            
              
            

            <code class="ruby">        @plan_data = plan_data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="11">
            
              <span class="hits">78</span>
            

            
              
            

            <code class="ruby">        @plan = plan_data[:plan]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="12">
            
              <span class="hits">78</span>
            

            
              
            

            <code class="ruby">        @analyze = plan_data[:analyze]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def render_summary</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="16">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="else branch hit 11 times">
                  else: 11
                </span>
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">        return &quot;&quot; unless @plan &amp;&amp; @plan.is_a?(Array) &amp;&amp; @plan.first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="18">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        root_plan = @plan.first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="19">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        execution_time = root_plan[&quot;Execution Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="20">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        planning_time = root_plan[&quot;Planning Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="21">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        total_cost = root_plan[&quot;Plan&quot;][&quot;Total Cost&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="22">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        actual_rows = root_plan[&quot;Plan&quot;][&quot;Actual Rows&quot;] if @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="24">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        hotspots = find_hotspots(root_plan[&quot;Plan&quot;]) if @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="25">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        index_analysis = analyze_index_usage(root_plan[&quot;Plan&quot;])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="26">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        buffer_stats = collect_buffer_stats(root_plan[&quot;Plan&quot;]) if @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="27">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        recommendations = generate_recommendations(root_plan, index_analysis, buffer_stats)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="29">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        summary_html = &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">          &lt;div class=&quot;bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">            &lt;h3 class=&quot;text-lg font-semibold text-gray-900 mb-4&quot;&gt;Execution Summary&lt;/h3&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">        HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="35">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        if execution_time</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="36">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 border-blue-400&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Execution Time&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{execution_time}ms&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;Actual wall-clock time to execute the query.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="45">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        if planning_time</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="46">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 border-green-400&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Planning Time&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{planning_time}ms&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;Time spent choosing the best execution strategy.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="11" data-linenumber="55">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 11 times">
                  then: 11
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">        if total_cost</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="56">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 border-purple-400&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Total Cost&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{total_cost}&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;Arbitrary units representing estimated I/O and CPU work. Lower is better.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="65">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        if actual_rows</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="66">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 border-yellow-400&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Rows Returned&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{number_with_delimiter(actual_rows)}&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;Number of rows the query actually produced.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
            

            <code class="ruby">        # Add index usage summary</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="76">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby">          &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 border-indigo-400&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Index Usage&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{index_analysis[:index_scans]} / #{index_analysis[:total_scans]} scans&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;How many data lookups used an index vs scanning the whole table. Higher is better.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            
              
            

            <code class="ruby">          &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            
              
            

            <code class="ruby">        HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            
              
            

            <code class="ruby">        # Add cache hit ratio if we have buffer stats</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="85">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        if buffer_stats &amp;&amp; buffer_stats[:total_blocks] &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="86">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">          hit_ratio = ((buffer_stats[:hit_blocks].to_f / buffer_stats[:total_blocks]) * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="87">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">          hit_color = hit_ratio &gt;= 99 ? &quot;border-green-400&quot; : (hit_ratio &gt;= 90 ? &quot;border-yellow-400&quot; : &quot;border-red-400&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="88">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;bg-white p-4 rounded-md border-l-4 #{hit_color}&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs font-medium text-gray-500 uppercase tracking-wide&quot;&gt;Cache Hit Ratio&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-lg font-semibold text-gray-900 font-mono&quot;&gt;#{hit_ratio}%&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs text-gray-400 mt-1&quot;&gt;Percentage of data pages found in memory. Below 99% may indicate insufficient shared_buffers.&lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="97">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        summary_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            
              
            

            <code class="ruby">        # Index analysis section</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="100">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        if index_analysis[:warnings].any? || index_analysis[:indexes_used].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="101">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;mt-6&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            
              
            

            <code class="ruby">              &lt;h4 class=&quot;text-md font-medium text-gray-900 mb-3&quot;&gt;Index Analysis&lt;/h4&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="106">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">          if index_analysis[:indexes_used].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="107">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;bg-green-50 border border-green-200 rounded-md p-3 mb-3&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            
              
            

            <code class="ruby">                &lt;div class=&quot;flex&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            
              
            

            <code class="ruby">                  &lt;div class=&quot;flex-shrink-0&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            
              
            

            <code class="ruby">                    &lt;svg class=&quot;h-5 w-5 text-green-400&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            
              
            

            <code class="ruby">                      &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z&quot; clip-rule=&quot;evenodd&quot; /&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby">                    &lt;/svg&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            
              
            

            <code class="ruby">                  &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            
              
            

            <code class="ruby">                  &lt;div class=&quot;ml-3&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            
              
            

            <code class="ruby">                    &lt;p class=&quot;text-sm font-medium text-green-800&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby">                      &lt;strong&gt;Indexes Used:&lt;/strong&gt; #{ERB::Util.html_escape(index_analysis[:indexes_used].join(&quot;, &quot;))}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            
              
            

            <code class="ruby">                    &lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            
              
            

            <code class="ruby">                  &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            
              
            

            <code class="ruby">                &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            
              
            

            <code class="ruby">              &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby">            HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="125">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          if index_analysis[:warnings].any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="126">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            index_analysis[:warnings].each do |warning|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="127">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">              summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby">                &lt;div class=&quot;bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-2&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            
              
            

            <code class="ruby">                  &lt;div class=&quot;flex&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            
              
            

            <code class="ruby">                    &lt;div class=&quot;flex-shrink-0&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            
              
            

            <code class="ruby">                      &lt;svg class=&quot;h-5 w-5 text-yellow-400&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            
              
            

            <code class="ruby">                        &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z&quot; clip-rule=&quot;evenodd&quot; /&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            
              
            

            <code class="ruby">                      &lt;/svg&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            
              
            

            <code class="ruby">                    &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            
              
            

            <code class="ruby">                    &lt;div class=&quot;ml-3&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            
              
            

            <code class="ruby">                      &lt;p class=&quot;text-sm text-yellow-700&quot;&gt;#{ERB::Util.html_escape(warning)}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            
              
            

            <code class="ruby">                    &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            
              
            

            <code class="ruby">                  &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby">                &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            
              
            

            <code class="ruby">              HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="144">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          summary_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="147">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        if hotspots &amp;&amp; hotspots.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="148">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;mt-6&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            
              
            

            <code class="ruby">              &lt;h4 class=&quot;text-md font-medium text-gray-900 mb-3&quot;&gt;Performance Hotspots&lt;/h4&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="153">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          hotspots.first(3).each do |hotspot|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="154">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">            summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;bg-red-50 border border-red-200 rounded-md p-3 mb-2&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            
              
            

            <code class="ruby">                &lt;p class=&quot;text-sm font-mono text-red-700&quot;&gt;#{ERB::Util.html_escape(hotspot)}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            
              
            

            <code class="ruby">              &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            
              
            

            <code class="ruby">            HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="161">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          summary_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            
              
            

            <code class="ruby">        # Recommendations section</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="165">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 10 times">
                  then: 10
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        if recommendations.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="166">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;mt-6&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            
              
            

            <code class="ruby">              &lt;h4 class=&quot;text-md font-medium text-gray-900 mb-3&quot;&gt; Recommendations&lt;/h4&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            
              
            

            <code class="ruby">          HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="171">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          recommendations.each do |rec|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="172">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="when branch hit 4 times">
                  when: 4
                </span>
              
            

            <code class="ruby">            icon = case rec[:severity]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="173">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="when branch hit 12 times">
                  when: 12
                </span>
              
            

            <code class="ruby">            when :critical then &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="174">
            
              <span class="hits">12</span>
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">            when :warning then &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="175">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            when :info then &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            
              
            

            <code class="ruby">            else &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="179">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="when branch hit 4 times">
                  when: 4
                </span>
              
            

            <code class="ruby">            border_class = case rec[:severity]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="180">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="when branch hit 12 times">
                  when: 12
                </span>
              
            

            <code class="ruby">            when :critical then &quot;border-red-300 bg-red-50&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="181">
            
              <span class="hits">12</span>
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">            when :warning then &quot;border-yellow-300 bg-yellow-50&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="182">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            when :info then &quot;border-blue-300 bg-blue-50&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            
              
            

            <code class="ruby">            else &quot;border-gray-300 bg-gray-50&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="186">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="when branch hit 4 times">
                  when: 4
                </span>
              
            

            <code class="ruby">            text_class = case rec[:severity]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="187">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="when branch hit 12 times">
                  when: 12
                </span>
              
            

            <code class="ruby">            when :critical then &quot;text-red-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="188">
            
              <span class="hits">12</span>
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">            when :warning then &quot;text-yellow-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="189">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            when :info then &quot;text-blue-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            
              
            

            <code class="ruby">            else &quot;text-gray-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="193">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;border #{border_class} rounded-md p-4 mb-3&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            
              
            

            <code class="ruby">                &lt;div class=&quot;flex items-start&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            
              
            

            <code class="ruby">                  &lt;span class=&quot;text-lg mr-3 flex-shrink-0&quot;&gt;#{icon}&lt;/span&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            
              
            

            <code class="ruby">                  &lt;div class=&quot;flex-1&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            
              
            

            <code class="ruby">                    &lt;p class=&quot;text-sm font-semibold #{text_class}&quot;&gt;#{ERB::Util.html_escape(rec[:title])}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            
              
            

            <code class="ruby">                    &lt;p class=&quot;text-sm #{text_class} mt-1&quot;&gt;#{ERB::Util.html_escape(rec[:description])}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            
              
            

            <code class="ruby">            HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="202">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 16 times">
                  then: 16
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">            if rec[:action]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="203">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">              summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            
              
            

            <code class="ruby">                    &lt;div class=&quot;mt-2 bg-white bg-opacity-60 rounded p-2&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            
              
            

            <code class="ruby">                      &lt;p class=&quot;text-xs font-medium text-gray-600&quot;&gt;Suggested action:&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            
              
            

            <code class="ruby">                      &lt;code class=&quot;text-xs font-mono text-gray-800 break-all&quot;&gt;#{ERB::Util.html_escape(rec[:action])}&lt;/code&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            
              
            

            <code class="ruby">                    &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            
              
            

            <code class="ruby">              HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="211">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            summary_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            
              
            

            <code class="ruby">                  &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            
              
            

            <code class="ruby">                &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            
              
            

            <code class="ruby">              &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            
              
            

            <code class="ruby">            HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="218">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          summary_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="221">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        summary_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="222">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        summary_html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="225">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def render_tree</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="226">
            
              <span class="hits">20</span>
            

            
              
                <span class="hits" title="else branch hit 19 times">
                  else: 19
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        return &quot;&quot; unless @plan &amp;&amp; @plan.is_a?(Array) &amp;&amp; @plan.first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="228">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">        root_plan = @plan.first[&quot;Plan&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="229">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">        tree_html = &#39;&lt;div class=&quot;font-mono text-sm space-y-2&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="230">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">        tree_html += render_node(root_plan, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="231">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">        tree_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="232">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">        tree_html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="235">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="237">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def render_node(node, depth)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="238">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        node_id = &quot;node_#{SecureRandom.hex(6)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="239">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        warnings = detect_warnings(node)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="241">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html = &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            
              
            

            <code class="ruby">          &lt;div class=&quot;border border-gray-200 rounded-lg bg-white shadow-sm&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            
              
            

            <code class="ruby">            &lt;div class=&quot;p-3 cursor-pointer select-none relative bg-gray-50 border-b border-gray-200 rounded-t-lg hover:bg-gray-100&quot; onclick=&quot;toggleNode(&#39;#{node_id}&#39;)&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            
              
            

            <code class="ruby">        HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="246">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 21 times">
                  else: 21
                </span>
              
            

            <code class="ruby">        if has_children?(node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="247">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          html += &#39;&lt;button class=&quot;absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 border-none bg-blue-600 text-white rounded-sm text-xs font-bold cursor-pointer hover:bg-blue-700&quot;&gt;&lt;/button&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="250">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += &#39;&lt;div class=&quot;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="251">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 21 times">
                  else: 21
                </span>
              
            

            <code class="ruby">        html += has_children?(node) ? &quot;ml-8&quot; : &quot;ml-3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="252">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += &#39; flex flex-wrap items-center gap-2&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="253">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += render_node_title(node, warnings)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="254">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += &quot;&lt;/div&gt;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="256">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += &#39;&lt;div class=&quot;plan-node-body&quot; id=&quot;&#39; + node_id + &#39;&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="257">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += render_node_details(node)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="259">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 21 times">
                  else: 21
                </span>
              
            

            <code class="ruby">        if has_children?(node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="260">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          html += &#39;&lt;div class=&quot;pl-6 space-y-2&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="261">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          children = node[&quot;Plans&quot;] || []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="262">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          children.each do |child|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="263">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">            html += render_node(child, depth + 1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="265">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="268">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html += &quot;&lt;/div&gt;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="269">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="272">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def render_node_title(node, warnings)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="273">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        node_type = node[&quot;Node Type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="274">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        title_html = &quot;&lt;span class=\&quot;font-bold text-gray-700&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            
              
            

            <code class="ruby">        # Add special styling for index operations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="277">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">        if node_type.include?(&quot;Index&quot;) || node_type == &quot;Bitmap Index Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="278">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="else branch hit 25 times">
                  else: 25
                </span>
              
            

            <code class="ruby">          title_html += &quot; text-green-700 bg-green-100 px-2 py-1 rounded&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="279">
            
              <span class="hits">25</span>
            

            
              
                <span class="hits" title="then branch hit 19 times">
                  then: 19
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        elsif node_type == &quot;Seq Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="280">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; text-red-700 bg-red-100 px-2 py-1 rounded&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="283">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        title_html += &quot;\&quot;&gt;#{ERB::Util.html_escape(node_type)}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="285">
            

            
              
            

            <code class="ruby">        # Add relation name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="286">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 20 times">
                  then: 20
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        if node[&quot;Relation Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="287">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">          relation_name = node[&quot;Relation Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="288">
            
              <span class="hits">20</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 19 times">
                  else: 19
                </span>
              
            

            <code class="ruby">          relation_name += &quot;.#{node[&quot;Schema&quot;]}&quot; if node[&quot;Schema&quot;] &amp;&amp; node[&quot;Schema&quot;] != &quot;public&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="289">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;text-blue-600 font-semibold\&quot;&gt;#{ERB::Util.html_escape(relation_name)}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="291">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="292">
            

            
              
            

            <code class="ruby">        # Add index name with emphasis</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="293">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 25 times">
                  else: 25
                </span>
              
            

            <code class="ruby">        if node[&quot;Index Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="294">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;text-green-700 font-bold bg-green-100 px-2 py-1 rounded inline-flex items-center\&quot;&gt; #{ERB::Util.html_escape(node[&quot;Index Name&quot;])}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="295">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            
              
            

            <code class="ruby">        # Add timing info for ANALYZE</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="298">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 18 times">
                  else: 18
                </span>
              
            

            <code class="ruby">        if @analyze &amp;&amp; node[&quot;Actual Total Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="299">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">          time_class = node[&quot;Actual Total Time&quot;] &gt; 100 ? &quot;text-red-600 bg-red-100&quot; : &quot;text-green-600 bg-green-100&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="300">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;#{time_class} px-2 py-1 rounded font-semibold\&quot;&gt;#{node[&quot;Actual Total Time&quot;]}ms&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="301">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            
              
            

            <code class="ruby">        # Add row count info with better ratio analysis</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="304">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
            

            <code class="ruby">        if @analyze &amp;&amp; node[&quot;Actual Rows&quot;] &amp;&amp; node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="305">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          actual = node[&quot;Actual Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="306">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          estimated = node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="307">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          abs_diff = (actual - estimated).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="9" data-linenumber="308">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          ratio = estimated &gt; 0 ? (actual.to_f / estimated).round(2) : (actual == 0 ? 1.0 : &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="310">
            

            
              
            

            <code class="ruby">          # Only flag as problematic when the absolute difference is large enough</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            
              
            

            <code class="ruby">          # to actually affect plan choice. Small diffs (e.g. 0 vs 1) are harmless.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="312">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          if abs_diff &lt;= 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby">            # Small absolute difference  never a real problem</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="314">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">            ratio_class = &quot;text-blue-600 bg-blue-100&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="315">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
            

            <code class="ruby">          elsif ratio.is_a?(Numeric)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="316">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">            if ratio &lt; 0.1 || ratio &gt; 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">              # 10x+ mismatch with &gt;100 row diff  likely a bad plan</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="318">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">              ratio_class = &quot;text-red-600 bg-red-100 font-bold&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="319">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            elsif ratio &lt; 0.5 || ratio &gt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">              # 2x10x mismatch  planner estimate is noticeably off</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="321">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">              ratio_class = &quot;text-orange-600 bg-orange-100&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            
              
            

            <code class="ruby">            else</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="" data-linenumber="323">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">              # Within 2x  estimate is fine</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            
              
            

            <code class="ruby">              ratio_class = &quot;text-blue-600 bg-blue-100&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="" data-linenumber="326">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            
              
            

            <code class="ruby">            ratio_class = &quot;text-red-600 bg-red-100 font-bold&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="330">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;#{ratio_class} px-2 py-1 rounded\&quot;&gt;#{number_with_delimiter(actual)} rows&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="331">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">          if ratio_class.include?(&quot;red&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="332">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">            title_html += &quot;  (est: #{number_with_delimiter(estimated)})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="333">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">          elsif ratio_class.include?(&quot;orange&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="334">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            title_html += &quot;  (est: #{number_with_delimiter(estimated)})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="336">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">            title_html += &quot; (est: #{number_with_delimiter(estimated)})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="337">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="338">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="else branch hit 18 times">
                  else: 18
                </span>
              
            

            <code class="ruby">          title_html += &quot;&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="18" data-linenumber="339">
            
              <span class="hits">18</span>
            

            
              
                <span class="hits" title="then branch hit 18 times">
                  then: 18
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">        elsif node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="340">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;text-blue-600 bg-blue-100 px-2 py-1 rounded\&quot;&gt;#{number_with_delimiter(node[&quot;Plan Rows&quot;])} rows&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="341">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            
              
            

            <code class="ruby">        # Add warning badges</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="344">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        warnings.each do |warning|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="345">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          case warning[:type]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            
              
                <span class="hits" title="when branch hit 3 times">
                  when: 3
                </span>
              
            

            <code class="ruby">          when &quot;seq-scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="347">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            badge_class = &quot;bg-red-100 text-red-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="" data-linenumber="348">
            

            
              
                <span class="hits" title="when branch hit 0 times">
                  when: 0
                </span>
              
            

            <code class="ruby">          when &quot;sort&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            
              
            

            <code class="ruby">            badge_class = &quot;bg-yellow-100 text-yellow-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="" data-linenumber="350">
            

            
              
                <span class="hits" title="when branch hit 0 times">
                  when: 0
                </span>
              
            

            <code class="ruby">          when &quot;nested-loop&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            
              
            

            <code class="ruby">            badge_class = &quot;bg-green-100 text-green-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            
              
                <span class="hits" title="when branch hit 3 times">
                  when: 3
                </span>
              
            

            <code class="ruby">          when &quot;fanout&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="353">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            badge_class = &quot;bg-blue-100 text-blue-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="" data-linenumber="354">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            
              
            

            <code class="ruby">            badge_class = &quot;bg-gray-100 text-gray-800&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="358">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          title_html += &quot; &lt;span class=\&quot;inline-flex items-center px-2 py-1 rounded text-xs font-medium #{badge_class}\&quot;&gt;#{ERB::Util.html_escape(warning[:text])}&lt;/span&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="361">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        title_html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="362">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="364">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def render_node_details(node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="365">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        details_html = &#39;&lt;div class=&quot;p-4 bg-gray-50 border-t border-gray-200&quot;&gt;&lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="367">
            

            
              
            

            <code class="ruby">        # Show key plan details</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="368">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        details = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="27" data-linenumber="370">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 27 times">
                  then: 27
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">        if node[&quot;Startup Cost&quot;] &amp;&amp; node[&quot;Total Cost&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="371">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Cost&quot;, &quot;#{node[&quot;Startup Cost&quot;]}..#{node[&quot;Total Cost&quot;]}&quot;, &quot;Startup cost (before first row) to total cost (all rows). Arbitrary units  compare relative to other nodes.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="374">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 10 times">
                  then: 10
                </span>
              
                <span class="hits" title="else branch hit 17 times">
                  else: 17
                </span>
              
            

            <code class="ruby">        if @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="375">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          if node[&quot;Actual Startup Time&quot;] &amp;&amp; node[&quot;Actual Total Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="376">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">            details &lt;&lt; [ &quot;Actual Time&quot;, &quot;#{node[&quot;Actual Startup Time&quot;]}..#{node[&quot;Actual Total Time&quot;]} ms&quot;, &quot;Real time: from start until all rows returned for this node.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="377">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="379">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 9 times">
                  else: 9
                </span>
              
            

            <code class="ruby">          if node[&quot;Actual Loops&quot;] &amp;&amp; node[&quot;Actual Loops&quot;] &gt; 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="380">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            details &lt;&lt; [ &quot;Loops&quot;, node[&quot;Actual Loops&quot;].to_s, &quot;Number of times this operation was repeated (e.g. once per row from a parent join).&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="382">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="383">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 9 times">
                  else: 9
                </span>
              
            

            <code class="ruby">          if node[&quot;Shared Hit Blocks&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="384">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            buffers = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="385">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            buffers &lt;&lt; &quot;hit=#{node[&quot;Shared Hit Blocks&quot;]}&quot; if node[&quot;Shared Hit Blocks&quot;] &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="386">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            buffers &lt;&lt; &quot;read=#{node[&quot;Shared Read Blocks&quot;]}&quot; if node[&quot;Shared Read Blocks&quot;] &amp;&amp; node[&quot;Shared Read Blocks&quot;] &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="387">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            buffers &lt;&lt; &quot;written=#{node[&quot;Shared Written Blocks&quot;]}&quot; if node[&quot;Shared Written Blocks&quot;] &amp;&amp; node[&quot;Shared Written Blocks&quot;] &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="388">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            details &lt;&lt; [ &quot;Buffers&quot;, buffers.join(&quot;, &quot;), &quot;Shared memory pages accessed. &#39;hit&#39; = cached in RAM, &#39;read&#39; = fetched from disk.&quot; ] if buffers.any?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="389">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="392">
            

            
              
            

            <code class="ruby">        # Index-specific details</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="393">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Index Cond&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="394">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Index Condition&quot;, node[&quot;Index Cond&quot;], &quot;The WHERE clause condition evaluated using the index for fast lookup.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="397">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Recheck Cond&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="398">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Recheck Condition&quot;, node[&quot;Recheck Cond&quot;], &quot;Condition re-verified against actual rows after a bitmap scan.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="399">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="401">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 25 times">
                  else: 25
                </span>
              
            

            <code class="ruby">        if node[&quot;Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="402">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Filter&quot;, node[&quot;Filter&quot;], &quot;Rows matching the scan are then filtered by this condition. Rows that don&#39;t match are discarded.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="403">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="405">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 25 times">
                  else: 25
                </span>
              
            

            <code class="ruby">        if node[&quot;Rows Removed by Filter&quot;] &amp;&amp; @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="406">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          removed = node[&quot;Rows Removed by Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="407">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          actual = node[&quot;Actual Rows&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="408">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          total = actual + removed</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="2" data-linenumber="409">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if removed &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="2" data-linenumber="410">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            efficiency = total &gt; 0 ? ((actual.to_f / total) * 100).round(1) : 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="411">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            details &lt;&lt; [ &quot;Filter Efficiency&quot;, &quot;#{efficiency}% (#{number_with_delimiter(removed)} rows filtered out)&quot;, &quot;Percentage of scanned rows that matched the filter. Low efficiency may indicate a missing or suboptimal index.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="415">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Join Type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="416">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Join Type&quot;, node[&quot;Join Type&quot;], &quot;How two result sets are combined (e.g. Hash, Nested Loop, Merge).&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="419">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Hash Cond&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="420">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Hash Condition&quot;, node[&quot;Hash Cond&quot;], &quot;The equality condition used to match rows in a hash join.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="421">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="422">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="423">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Sort Key&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="424">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          sort_keys = node[&quot;Sort Key&quot;].is_a?(Array) ? node[&quot;Sort Key&quot;].join(&quot;, &quot;) : node[&quot;Sort Key&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="425">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Sort Key&quot;, sort_keys, &quot;Column(s) used to order the result set.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="427">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="428">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">        if node[&quot;Sort Method&quot;] &amp;&amp; @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="429">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          sort_info = node[&quot;Sort Method&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="430">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if node[&quot;Sort Space Used&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="431">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            sort_info += &quot; (#{node[&quot;Sort Space Used&quot;]}kB&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="432">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">            sort_info += node[&quot;Sort Space Type&quot;] == &quot;Disk&quot; ? &quot; on disk&quot; : &quot; in memory&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="433">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            sort_info += &quot;)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="434">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="435">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          details &lt;&lt; [ &quot;Sort Method&quot;, sort_info, &quot;Algorithm used for sorting. In-memory is fast; disk-based sorting indicates insufficient work_mem.&quot; ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="436">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="437">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            

            
              
            

            <code class="ruby">        # Split details into two columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="439">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        left_details = details.first((details.length + 1) / 2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="440">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        right_details = details.drop(left_details.length)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="441">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="442">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        [ left_details, right_details ].each do |column_details|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="443">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">          details_html += &#39;&lt;div class=&quot;space-y-2&quot;&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="444">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">          column_details.each do |label, value, explanation|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="445">
            
              <span class="hits">48</span>
            

            
              
            

            <code class="ruby">            details_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="446">
            

            
              
            

            <code class="ruby">              &lt;div class=&quot;text-xs&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="447">
            

            
              
            

            <code class="ruby">                &lt;dt class=&quot;font-medium text-gray-600&quot;&gt;#{ERB::Util.html_escape(label)}:&lt;/dt&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="448">
            

            
              
            

            <code class="ruby">                &lt;dd class=&quot;mt-1 text-gray-900 font-mono break-words&quot;&gt;#{ERB::Util.html_escape(value)}&lt;/dd&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="449">
            

            
              
            

            <code class="ruby">            HTML</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="48" data-linenumber="450">
            
              <span class="hits">48</span>
            

            
              
                <span class="hits" title="then branch hit 48 times">
                  then: 48
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            if explanation</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="451">
            
              <span class="hits">48</span>
            

            
              
            

            <code class="ruby">              details_html += &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="452">
            

            
              
            

            <code class="ruby">                &lt;dd class=&quot;mt-0.5 text-gray-400 font-sans italic&quot;&gt;#{ERB::Util.html_escape(explanation)}&lt;/dd&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            
              
            

            <code class="ruby">              HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="454">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="455">
            
              <span class="hits">48</span>
            

            
              
            

            <code class="ruby">            details_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="456">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="457">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">          details_html += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="460">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        details_html += &quot;&lt;/div&gt;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="461">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        details_html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="463">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="464">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def detect_warnings(node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="465">
            
              <span class="hits">35</span>
            

            
              
            

            <code class="ruby">        warnings = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="466">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            
              
            

            <code class="ruby">        # Enhanced Seq Scan warning with table name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="468">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 24 times">
                  then: 24
                </span>
              
                <span class="hits" title="else branch hit 11 times">
                  else: 11
                </span>
              
            

            <code class="ruby">        if node[&quot;Node Type&quot;] == &quot;Seq Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="469">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">          table_name = node[&quot;Relation Name&quot;] || &quot;table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="470">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">          row_count = node[&quot;Plan Rows&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="472">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">          if row_count &gt; 10000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="473">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="else branch hit 23 times">
                  else: 23
                </span>
              
            

            <code class="ruby">            warnings &lt;&lt; { type: &quot;seq-scan&quot;, text: &quot;Large Seq Scan (#{number_with_delimiter(row_count)} rows on #{table_name})&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="474">
            
              <span class="hits">23</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 21 times">
                  else: 21
                </span>
              
            

            <code class="ruby">          elsif row_count &gt; 1000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="475">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            warnings &lt;&lt; { type: &quot;seq-scan&quot;, text: &quot;Seq Scan (#{table_name})&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="476">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="477">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            

            
              
            

            <code class="ruby">        # Bitmap Heap Scan warnings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="480">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 34 times">
                  else: 34
                </span>
              
            

            <code class="ruby">        if node[&quot;Node Type&quot;] == &quot;Bitmap Heap Scan&quot; &amp;&amp; node[&quot;Plan Rows&quot;] &amp;&amp; node[&quot;Plan Rows&quot;] &gt; 10000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="481">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          warnings &lt;&lt; { type: &quot;sort&quot;, text: &quot;Large Bitmap Scan&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="482">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="483">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            

            
              
            

            <code class="ruby">        # Large sort warning</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="485">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 34 times">
                  else: 34
                </span>
              
            

            <code class="ruby">        if node[&quot;Node Type&quot;] == &quot;Sort&quot; &amp;&amp; node[&quot;Plan Rows&quot;] &amp;&amp; node[&quot;Plan Rows&quot;] &gt; 10000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="486">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          warnings &lt;&lt; { type: &quot;sort&quot;, text: &quot;Large Sort (#{number_with_delimiter(node[&quot;Plan Rows&quot;])} rows)&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="488">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="489">
            

            
              
            

            <code class="ruby">        # Nested loop with large inner</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="490">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 34 times">
                  else: 34
                </span>
              
            

            <code class="ruby">        if node[&quot;Node Type&quot;] == &quot;Nested Loop&quot; &amp;&amp; node[&quot;Plans&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="491">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          inner_rows = node[&quot;Plans&quot;].map { |p| p[&quot;Plan Rows&quot;] || 0 }.max</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="492">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if inner_rows &amp;&amp; inner_rows &gt; 1000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="493">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            warnings &lt;&lt; { type: &quot;nested-loop&quot;, text: &quot;Large Nested Loop (#{number_with_delimiter(inner_rows)} inner rows)&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="494">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="495">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="496">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="497">
            

            
              
            

            <code class="ruby">        # Row explosion (fanout)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="498">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 10 times">
                  then: 10
                </span>
              
                <span class="hits" title="else branch hit 25 times">
                  else: 25
                </span>
              
            

            <code class="ruby">        if @analyze &amp;&amp; node[&quot;Actual Rows&quot;] &amp;&amp; node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="499">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          actual = node[&quot;Actual Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="500">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          estimated = node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="501">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">          if estimated &gt; 0 &amp;&amp; actual &gt; estimated * 10</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="502">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">            ratio = (actual.to_f / estimated).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="503">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">            warnings &lt;&lt; { type: &quot;fanout&quot;, text: &quot;Row Explosion (#{ratio}x estimate)&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="504">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="505">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="507">
            

            
              
            

            <code class="ruby">        # Index usage analysis</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="508">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">        if node[&quot;Node Type&quot;].include?(&quot;Index&quot;) &amp;&amp; node[&quot;Index Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="509">
            

            
              
            

            <code class="ruby">          # This is good - using an index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="510">
            

            
              
                <span class="hits" title="else branch hit 33 times">
                  else: 33
                </span>
              
            

            <code class="ruby">          # Could add positive feedback here in the future</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="511">
            
              <span class="hits">33</span>
            

            
              
                <span class="hits" title="else branch hit 30 times">
                  else: 30
                </span>
              
            

            <code class="ruby">        elsif node[&quot;Node Type&quot;] == &quot;Seq Scan&quot; &amp;&amp; node[&quot;Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="512">
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">          # Sequential scan with filter suggests missing index opportunity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="513">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          warnings &lt;&lt; { type: &quot;seq-scan&quot;, text: &quot;Filtered Seq Scan (missing index?)&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="514">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="516">
            
              <span class="hits">35</span>
            

            
              
            

            <code class="ruby">        warnings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="517">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="518">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="519">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def has_children?(node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="520">
            
              <span class="hits">81</span>
            

            
              
            

            <code class="ruby">        node[&quot;Plans&quot;] &amp;&amp; node[&quot;Plans&quot;].any?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="521">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="522">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="523">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def find_hotspots(plan_node, hotspots = [])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="524">
            
              <span class="hits">13</span>
            

            
              
                <span class="hits" title="else branch hit 12 times">
                  else: 12
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        return hotspots unless @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="525">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="526">
            

            
              
            

            <code class="ruby">        # Add this node if it&#39;s slow</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="527">
            
              <span class="hits">12</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        if plan_node[&quot;Actual Total Time&quot;] &amp;&amp; plan_node[&quot;Actual Total Time&quot;] &gt; 10</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="528">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          node_desc = &quot;#{plan_node[&quot;Node Type&quot;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="529">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          node_desc += &quot; on #{plan_node[&quot;Relation Name&quot;]}&quot; if plan_node[&quot;Relation Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="530">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          node_desc += &quot; (#{plan_node[&quot;Actual Total Time&quot;]}ms)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="531">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          hotspots &lt;&lt; node_desc</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="532">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="533">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="534">
            

            
              
            

            <code class="ruby">        # Recurse into children</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="535">
            
              <span class="hits">12</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 11 times">
                  else: 11
                </span>
              
            

            <code class="ruby">        if plan_node[&quot;Plans&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="536">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          plan_node[&quot;Plans&quot;].each do |child|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="537">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            find_hotspots(child, hotspots)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="538">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="539">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="540">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="541">
            

            
              
            

            <code class="ruby">        # Sort by time descending</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="542">
            
              <span class="hits">12</span>
            

            
              
            

            <code class="ruby">        hotspots.sort_by! do |desc|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="543">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          match = desc.match(/\((\d+\.?\d*)ms\)/)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="4" data-linenumber="544">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          match ? -match[1].to_f : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="545">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="546">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="547">
            
              <span class="hits">12</span>
            

            
              
            

            <code class="ruby">        hotspots</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="548">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="549">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="550">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def number_with_delimiter(number)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="551">
            
              <span class="hits">78</span>
            

            
              
            

            <code class="ruby">        number.to_s.reverse.gsub(/(\d{3})(?=\d)/, &#39;\\1,&#39;).reverse</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="552">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="553">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="554">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def analyze_index_usage(plan_node, analysis = { index_scans: 0, total_scans: 0, indexes_used: [], warnings: [], seq_scans: [] })</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="555">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">        node_type = plan_node[&quot;Node Type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="556">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="557">
            

            
              
            

            <code class="ruby">        # Count scan operations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="558">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 23 times">
                  then: 23
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        if node_type.include?(&quot;Scan&quot;) || node_type.include?(&quot;Seek&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="559">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">          analysis[:total_scans] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="560">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="561">
            
              <span class="hits">23</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
            

            <code class="ruby">          if node_type.include?(&quot;Index&quot;) || node_type == &quot;Bitmap Index Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="562">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">            analysis[:index_scans] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="563">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="564">
            

            
              
            

            <code class="ruby">            # Track which indexes are being used</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="6" data-linenumber="565">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            if plan_node[&quot;Index Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="566">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">              index_name = plan_node[&quot;Index Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="567">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">              relation = plan_node[&quot;Relation Name&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="6" data-linenumber="568">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">              full_name = relation ? &quot;#{relation}.#{index_name}&quot; : index_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="6" data-linenumber="569">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
            

            <code class="ruby">              analysis[:indexes_used] &lt;&lt; full_name unless analysis[:indexes_used].include?(full_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="570">
            

            
              
                <span class="hits" title="else branch hit 17 times">
                  else: 17
                </span>
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="17" data-linenumber="571">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 17 times">
                  then: 17
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          elsif node_type == &quot;Seq Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="572">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            table_name = plan_node[&quot;Relation Name&quot;] || &quot;unknown table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="573">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            row_count = plan_node[&quot;Plan Rows&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="574">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="575">
            

            
              
            

            <code class="ruby">            # Collect columns from filter conditions for index suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="576">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            filter_cols = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="577">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 10 times">
                  else: 10
                </span>
              
            

            <code class="ruby">            filter_cols += extract_columns_from_condition(plan_node[&quot;Filter&quot;]) if plan_node[&quot;Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="578">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="579">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">            analysis[:seq_scans] &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="580">
            

            
              
            

            <code class="ruby">              table: table_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="581">
            

            
              
            

            <code class="ruby">              rows: row_count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="582">
            

            
              
            

            <code class="ruby">              filter: plan_node[&quot;Filter&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="583">
            

            
              
            

            <code class="ruby">              columns: filter_cols</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="584">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="585">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="586">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">            if row_count &gt; 10000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="587">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="else branch hit 14 times">
                  else: 14
                </span>
              
            

            <code class="ruby">              analysis[:warnings] &lt;&lt; &quot;Large sequential scan on #{table_name} (#{number_with_delimiter(row_count)} rows)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="588">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
                <span class="hits" title="else branch hit 11 times">
                  else: 11
                </span>
              
            

            <code class="ruby">            elsif row_count &gt; 1000 &amp;&amp; plan_node[&quot;Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="589">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">              analysis[:warnings] &lt;&lt; &quot;Sequential scan with filter on #{table_name} - consider adding index&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="590">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="591">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="592">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="593">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="594">
            

            
              
            

            <code class="ruby">        # Recurse into child nodes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="595">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 23 times">
                  else: 23
                </span>
              
            

            <code class="ruby">        if plan_node[&quot;Plans&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="596">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          plan_node[&quot;Plans&quot;].each do |child|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="597">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            analyze_index_usage(child, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="598">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="599">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="600">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="601">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">        analysis</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="602">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="603">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="604">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def collect_buffer_stats(node, stats = { hit_blocks: 0, read_blocks: 0, written_blocks: 0, total_blocks: 0 })</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="605">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 10 times">
                  then: 10
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        if node[&quot;Shared Hit Blocks&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="606">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          stats[:hit_blocks] += node[&quot;Shared Hit Blocks&quot;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="607">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          stats[:total_blocks] += node[&quot;Shared Hit Blocks&quot;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="609">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 10 times">
                  then: 10
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        if node[&quot;Shared Read Blocks&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="610">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          stats[:read_blocks] += node[&quot;Shared Read Blocks&quot;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="611">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">          stats[:total_blocks] += node[&quot;Shared Read Blocks&quot;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="612">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="613">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 14 times">
                  else: 14
                </span>
              
            

            <code class="ruby">        if node[&quot;Shared Written Blocks&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="614">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          stats[:written_blocks] += node[&quot;Shared Written Blocks&quot;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="615">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="616">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="16" data-linenumber="617">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 16 times">
                  else: 16
                </span>
              
            

            <code class="ruby">        if node[&quot;Plans&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="618">
            

            
              
            

            <code class="ruby">          node[&quot;Plans&quot;].each { |child| collect_buffer_stats(child, stats) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="619">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="620">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="621">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">        stats</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="622">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="623">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="624">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def generate_recommendations(root_plan, index_analysis, buffer_stats)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="625">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        recs = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="626">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        plan = root_plan[&quot;Plan&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="627">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        execution_time = root_plan[&quot;Execution Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="628">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        planning_time = root_plan[&quot;Planning Time&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="629">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="630">
            

            
              
            

            <code class="ruby">        # Walk the entire plan tree collecting issues</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="631">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        walk_plan_for_recommendations(plan, recs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="632">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="633">
            

            
              
            

            <code class="ruby">        # Planning time vs execution time</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="634">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 14 times">
                  then: 14
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        if planning_time &amp;&amp; execution_time &amp;&amp; planning_time &gt; 0 &amp;&amp; execution_time &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="635">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 12 times">
                  else: 12
                </span>
              
            

            <code class="ruby">          if planning_time &gt; execution_time * 2 &amp;&amp; planning_time &gt; 5</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="636">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="637">
            

            
              
            

            <code class="ruby">              severity: :info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="638">
            

            
              
            

            <code class="ruby">              title: &quot;Planning time exceeds execution time&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="639">
            

            
              
            

            <code class="ruby">              description: &quot;The query planner spent #{planning_time}ms planning but only #{execution_time}ms executing. For frequently-run queries this overhead adds up.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="640">
            

            
              
            

            <code class="ruby">              action: &quot;Consider using prepared statements to skip repeated planning: connection.prepare(&#39;my_query&#39;, sql)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="641">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="642">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="643">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="644">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="645">
            

            
              
            

            <code class="ruby">        # Cache hit ratio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="646">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">        if buffer_stats &amp;&amp; buffer_stats[:total_blocks] &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="647">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          hit_ratio = (buffer_stats[:hit_blocks].to_f / buffer_stats[:total_blocks]) * 100</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="648">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">          if hit_ratio &lt; 90 &amp;&amp; buffer_stats[:read_blocks] &gt; 10</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="649">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="650">
            

            
              
            

            <code class="ruby">              severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="651">
            

            
              
            

            <code class="ruby">              title: &quot;Low cache hit ratio (#{hit_ratio.round(1)}%)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="652">
            

            
              
            

            <code class="ruby">              description: &quot;#{buffer_stats[:read_blocks]} pages were read from disk instead of cache. This slows queries significantly, especially under load.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="653">
            

            
              
            

            <code class="ruby">              action: &quot;Increase shared_buffers in postgresql.conf, or run the query again (it may now be cached).&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="654">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="655">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="656">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="657">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="658">
            

            
              
            

            <code class="ruby">        # Sequential scan warnings with specific index suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="659">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 14 times">
                  then: 14
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        if index_analysis[:total_scans] &gt; 0 &amp;&amp; index_analysis[:index_scans] == 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="660">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">          seq_scans = index_analysis[:seq_scans] || []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="661">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">          index_suggestions = seq_scans.select { |s| s[:columns].any? }.map do |scan|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="662">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">            cols = scan[:columns].join(&quot;, &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="663">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">            &quot;CREATE INDEX idx_#{scan[:table]}_on_#{scan[:columns].first} ON #{scan[:table]} (#{cols});&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="664">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="665">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="666">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby">          if index_suggestions.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="667">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="668">
            

            
              
            

            <code class="ruby">              severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="669">
            

            
              
            

            <code class="ruby">              title: &quot;No indexes used&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="670">
            

            
              
            

            <code class="ruby">              description: &quot;All #{index_analysis[:total_scans]} scan(s) in this query are sequential scans. This means PostgreSQL is reading entire tables to find matching rows.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="671">
            

            
              
            

            <code class="ruby">              action: index_suggestions.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="672">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="673">
            

            
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="674">
            

            
              
                <span class="hits" title="else branch hit 9 times">
                  else: 9
                </span>
              
            

            <code class="ruby">            # Couldn&#39;t extract columns  list the tables at least</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="675">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">            tables = seq_scans.map { |s| s[:table] }.uniq</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="676">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="677">
            

            
              
            

            <code class="ruby">              severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="678">
            

            
              
            

            <code class="ruby">              title: &quot;No indexes used&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="679">
            

            
              
            

            <code class="ruby">              description: &quot;All #{index_analysis[:total_scans]} scan(s) in this query are sequential scans on #{tables.join(&#39;, &#39;)}. This means PostgreSQL is reading entire tables to find matching rows.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="680">
            

            
              
            

            <code class="ruby">              action: &quot;Add indexes on the columns used in WHERE, JOIN, and ORDER BY clauses for: #{tables.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="681">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="682">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="683">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="684">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="685">
            

            
              
            

            <code class="ruby">        # Slow query overall</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="686">
            
              <span class="hits">17</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">        if execution_time &amp;&amp; execution_time &gt; 1000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="687">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="688">
            

            
              
            

            <code class="ruby">            severity: :critical,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="689">
            

            
              
            

            <code class="ruby">            title: &quot;Slow query (#{execution_time}ms)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="690">
            

            
              
            

            <code class="ruby">            description: &quot;This query took over 1 second to execute. Users will notice this delay. Consider optimizing the query or adding caching.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="691">
            

            
              
            

            <code class="ruby">            action: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="692">
            

            
              
                <span class="hits" title="else branch hit 15 times">
                  else: 15
                </span>
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="693">
            
              <span class="hits">15</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 14 times">
                  else: 14
                </span>
              
            

            <code class="ruby">        elsif execution_time &amp;&amp; execution_time &gt; 100</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="694">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="695">
            

            
              
            

            <code class="ruby">            severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="696">
            

            
              
            

            <code class="ruby">            title: &quot;Moderately slow query (#{execution_time}ms)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="697">
            

            
              
            

            <code class="ruby">            description: &quot;This query took over 100ms. It&#39;s acceptable for background jobs but may be too slow for web requests where &lt; 50ms is ideal.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="698">
            

            
              
            

            <code class="ruby">            action: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="699">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="700">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="701">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="702">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        recs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="703">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="704">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="705">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def walk_plan_for_recommendations(node, recs)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="706">
            
              <span class="hits">30</span>
            

            
              
            

            <code class="ruby">        node_type = node[&quot;Node Type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="707">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="708">
            

            
              
            

            <code class="ruby">        # Seq Scan with filter on a table</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="709">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 23 times">
                  else: 23
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Seq Scan&quot; &amp;&amp; node[&quot;Filter&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="710">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          table = node[&quot;Relation Name&quot;] || &quot;table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="711">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          rows = @analyze ? (node[&quot;Actual Rows&quot;] || node[&quot;Plan Rows&quot;] || 0) : (node[&quot;Plan Rows&quot;] || 0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="712">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          removed = node[&quot;Rows Removed by Filter&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="713">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="714">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if rows + removed &gt; 1000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="715">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">            filter_cols = extract_columns_from_condition(node[&quot;Filter&quot;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="716">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            col_suggestion = filter_cols.any? ? filter_cols.join(&quot;, &quot;) : &quot;the filtered column(s)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="717">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="718">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="719">
            

            
              
            

            <code class="ruby">              severity: :critical,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="720">
            

            
              
            

            <code class="ruby">              title: &quot;Sequential scan with filter on &#39;#{table}&#39;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="721">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">              description: &quot;PostgreSQL scanned #{number_with_delimiter(rows + removed)} rows but only kept #{number_with_delimiter(rows)} (#{removed &gt; 0 ? ((rows.to_f / (rows + removed)) * 100).round(1) : 100}% selectivity). A targeted index would avoid scanning irrelevant rows.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="722">
            

            
              
            

            <code class="ruby">              action: &quot;CREATE INDEX idx_#{table}_on_#{filter_cols.first || &#39;column&#39;} ON #{table} (#{col_suggestion});&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="723">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="724">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="725">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="726">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="727">
            

            
              
            

            <code class="ruby">        # Disk-based sort</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="728">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Sort&quot; &amp;&amp; @analyze &amp;&amp; node[&quot;Sort Space Type&quot;] == &quot;Disk&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="729">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          space = node[&quot;Sort Space Used&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="730">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="731">
            

            
              
            

            <code class="ruby">            severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="732">
            

            
              
            

            <code class="ruby">            title: &quot;Sort spilled to disk (#{space}kB)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="733">
            

            
              
            

            <code class="ruby">            description: &quot;The sort couldn&#39;t fit in memory and used disk, which is much slower. This happens when work_mem is too small for the data being sorted.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="734">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            action: &quot;SET work_mem = &#39;#{[ (space * 2 / 1024.0).ceil, 4 ].max}MB&#39;; -- or increase work_mem in postgresql.conf&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="735">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="736">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="737">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="738">
            

            
              
            

            <code class="ruby">        # Large in-memory sort</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="739">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Sort&quot; &amp;&amp; @analyze &amp;&amp; node[&quot;Sort Space Type&quot;] == &quot;Memory&quot; &amp;&amp; (node[&quot;Sort Space Used&quot;] || 0) &gt; 10000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="740">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="741">
            

            
              
            

            <code class="ruby">            severity: :info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="742">
            

            
              
            

            <code class="ruby">            title: &quot;Large in-memory sort (#{node[&quot;Sort Space Used&quot;]}kB)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="743">
            

            
              
            

            <code class="ruby">            description: &quot;The sort fits in memory but uses significant space. If this query runs concurrently, total memory usage could be high.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="744">
            

            
              
            

            <code class="ruby">            action: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="745">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="746">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="747">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="748">
            

            
              
            

            <code class="ruby">        # Nested loop with many iterations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="749">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Nested Loop&quot; &amp;&amp; @analyze &amp;&amp; node[&quot;Actual Loops&quot;] &amp;&amp; node[&quot;Actual Loops&quot;] &gt; 100</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="750">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="751">
            

            
              
            

            <code class="ruby">            severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="752">
            

            
              
            

            <code class="ruby">            title: &quot;Nested loop with #{number_with_delimiter(node[&quot;Actual Loops&quot;])} iterations&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="753">
            

            
              
            

            <code class="ruby">            description: &quot;The inner side of this join is executed #{number_with_delimiter(node[&quot;Actual Loops&quot;])} times. If the inner operation is not an index lookup, this can be extremely slow.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="754">
            

            
              
            

            <code class="ruby">            action: &quot;Consider restructuring the query to allow a hash join, or ensure the inner table has appropriate indexes.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="755">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="756">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="757">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="758">
            

            
              
            

            <code class="ruby">        # Large row estimate mismatch</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="759">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 28 times">
                  then: 28
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        if @analyze &amp;&amp; node[&quot;Actual Rows&quot;] &amp;&amp; node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="760">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">          actual = node[&quot;Actual Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="761">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">          estimated = node[&quot;Plan Rows&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="762">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">          abs_diff = (actual - estimated).abs</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="28" data-linenumber="763">
            
              <span class="hits">28</span>
            

            
              
                <span class="hits" title="then branch hit 28 times">
                  then: 28
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          ratio = estimated &gt; 0 ? (actual.to_f / estimated) : 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="764">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="765">
            
              <span class="hits">28</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 27 times">
                  else: 27
                </span>
              
            

            <code class="ruby">          if abs_diff &gt; 1000 &amp;&amp; (ratio &gt; 10 || ratio &lt; 0.1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="766">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            table = node[&quot;Relation Name&quot;] || &quot;the involved table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="767">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="768">
            

            
              
            

            <code class="ruby">              severity: :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="769">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">              title: &quot;Row estimate off by #{ratio &gt; 1 ? &quot;#{ratio.round(0)}x&quot; : &quot;#{(1.0 / ratio).round(0)}x&quot;} on #{node_type}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="770">
            

            
              
            

            <code class="ruby">              description: &quot;PostgreSQL estimated #{number_with_delimiter(estimated)} rows but got #{number_with_delimiter(actual)}. Bad estimates lead to suboptimal plan choices (wrong join type, wrong scan method).&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="771">
            

            
              
            

            <code class="ruby">              action: &quot;ANALYZE #{table}; -- updates table statistics so the planner makes better estimates&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="772">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="773">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="774">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="775">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="776">
            

            
              
            

            <code class="ruby">        # Hash join with large buckets</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="777">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Hash&quot; &amp;&amp; @analyze</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="778">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if node[&quot;Peak Memory Usage&quot;] &amp;&amp; node[&quot;Peak Memory Usage&quot;] &gt; 100_000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="779">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="780">
            

            
              
            

            <code class="ruby">              severity: :info,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="781">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">              title: &quot;Large hash table (#{(node[&quot;Peak Memory Usage&quot;] / 1024.0).round(1)}MB)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="782">
            

            
              
            

            <code class="ruby">              description: &quot;Building the hash table for this join used significant memory. Under concurrent load, this could cause memory pressure.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="783">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">              action: &quot;SET work_mem = &#39;#{[ (node[&quot;Peak Memory Usage&quot;] / 512.0).ceil, 4 ].max}MB&#39;; -- ensure enough memory for the hash&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="784">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="785">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="786">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="787">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="788">
            

            
              
            

            <code class="ruby">        # Bitmap Heap Scan with many recheck rows</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="789">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Bitmap Heap Scan&quot; &amp;&amp; @analyze &amp;&amp; node[&quot;Rows Removed by Index Recheck&quot;] &amp;&amp; node[&quot;Rows Removed by Index Recheck&quot;] &gt; 1000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="790">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="791">
            

            
              
            

            <code class="ruby">            severity: :info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="792">
            

            
              
            

            <code class="ruby">            title: &quot;Bitmap scan with heavy recheck&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="793">
            

            
              
            

            <code class="ruby">            description: &quot;#{number_with_delimiter(node[&quot;Rows Removed by Index Recheck&quot;])} rows were rechecked after the bitmap index scan. This happens when the bitmap becomes lossy (too many results).&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="794">
            

            
              
            

            <code class="ruby">            action: &quot;Increase work_mem to keep more exact page references, or add a more selective index.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="795">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="796">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="797">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="798">
            

            
              
            

            <code class="ruby">        # Correlated subquery (SubPlan node)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="799">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;SubPlan&quot; || node_type.start_with?(&quot;SubPlan&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="800">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          loops = node[&quot;Actual Loops&quot;] || node[&quot;Plan Rows&quot;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="801">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="802">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            severity: loops &gt; 100 ? :critical : :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="803">
            

            
              
            

            <code class="ruby">            title: &quot;Correlated subquery detected&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="804">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            description: &quot;A subquery is being executed once per row from the outer query#{loops &gt; 1 ? &quot; (#{number_with_delimiter(loops)} times)&quot; : &quot;&quot;}. This is one of the most common causes of slow queries.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="805">
            

            
              
            

            <code class="ruby">            action: &quot;Rewrite the correlated subquery as a JOIN or use a lateral join. Example: SELECT ... FROM outer_table LEFT JOIN (subquery) ON ... instead of SELECT ..., (SELECT ...) FROM outer_table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="806">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="807">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="808">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="809">
            

            
              
            

            <code class="ruby">        # Also catch SubPlan via parent node&#39;s Plans having subplan-type entries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="810">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node[&quot;Subplan Name&quot;] || (node[&quot;Parent Relationship&quot;] == &quot;SubPlan&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="811">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          loops = @analyze ? (node[&quot;Actual Loops&quot;] || 0) : (node[&quot;Plan Rows&quot;] || 0)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="812">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">          unless recs.any? { |r| r[:title] == &quot;Correlated subquery detected&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="813">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="814">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">              severity: loops &gt; 100 ? :critical : :warning,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="815">
            

            
              
            

            <code class="ruby">              title: &quot;Correlated subquery detected&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="816">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">              description: &quot;A subquery (#{node[&quot;Subplan Name&quot;] || node[&quot;Node Type&quot;]}) runs for each row of the outer query#{loops &gt; 1 ? &quot; (#{number_with_delimiter(loops)} executions)&quot; : &quot;&quot;}. This pattern scales poorly with table size.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="817">
            

            
              
            

            <code class="ruby">              action: &quot;Rewrite as a JOIN: replace WHERE col IN (SELECT ...) with an INNER JOIN, or WHERE EXISTS (SELECT ...) with a semi-join.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="818">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="819">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="820">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="821">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="822">
            

            
              
            

            <code class="ruby">        # CTE materialization warning</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="823">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;CTE Scan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="824">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          cte_name = node[&quot;CTE Name&quot;] || &quot;the CTE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="825">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="826">
            

            
              
            

            <code class="ruby">            severity: :info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="827">
            

            
              
            

            <code class="ruby">            title: &quot;Materialized CTE: #{cte_name}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="828">
            

            
              
            

            <code class="ruby">            description: &quot;The CTE &#39;#{cte_name}&#39; is materialized into a temporary result set before being scanned. If the CTE result is large or the outer query filters most rows, this can be wasteful.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="829">
            

            
              
            

            <code class="ruby">            action: &quot;WITH #{cte_name} AS NOT MATERIALIZED (SELECT ...) -- allows PostgreSQL to inline the CTE and apply outer filters (requires PostgreSQL 12+)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="830">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="831">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="832">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="833">
            

            
              
            

            <code class="ruby">        # Index Only Scan with high heap fetches</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="834">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node_type == &quot;Index Only Scan&quot; &amp;&amp; @analyze &amp;&amp; node[&quot;Heap Fetches&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="835">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          heap_fetches = node[&quot;Heap Fetches&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="836">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          actual_rows = node[&quot;Actual Rows&quot;] || 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="837">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if heap_fetches &gt; 0 &amp;&amp; actual_rows &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="838">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            fetch_ratio = (heap_fetches.to_f / actual_rows * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="839">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">            if fetch_ratio &gt; 50</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="840">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">              table = node[&quot;Relation Name&quot;] || &quot;the table&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="841">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">              recs &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="842">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">                severity: fetch_ratio &gt; 90 ? :warning : :info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="843">
            

            
              
            

            <code class="ruby">                title: &quot;Index Only Scan falling back to heap (#{fetch_ratio}%)&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="844">
            

            
              
            

            <code class="ruby">                description: &quot;#{number_with_delimiter(heap_fetches)} of #{number_with_delimiter(actual_rows)} rows required a heap fetch because the visibility map is out of date. This negates most of the benefit of an index-only scan.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="845">
            

            
              
            

            <code class="ruby">                action: &quot;VACUUM #{table}; -- refreshes the visibility map so future index-only scans can skip heap fetches&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="846">
            

            
              
            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="847">
            

            
              
            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="848">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="849">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="850">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="851">
            

            
              
            

            <code class="ruby">        # Recurse</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="852">
            
              <span class="hits">30</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">        if node[&quot;Plans&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="853">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          node[&quot;Plans&quot;].each { |child| walk_plan_for_recommendations(child, recs) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="854">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="855">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="856">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="857">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def extract_columns_from_condition(condition)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="858">
            
              <span class="hits">22</span>
            

            
              
                <span class="hits" title="else branch hit 20 times">
                  else: 20
                </span>
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">        return [] unless condition.is_a?(String)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="859">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="860">
            

            
              
            

            <code class="ruby">        # PostgreSQL EXPLAIN outputs conditions like:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="861">
            

            
              
            

            <code class="ruby">        #   (status = &#39;active&#39;::text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="862">
            

            
              
            

            <code class="ruby">        #   ((scheduled_at &gt;= &#39;2026-01-01&#39;::timestamp) AND (scheduled_at &lt;= &#39;2026-12-31&#39;::timestamp))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="863">
            

            
              
            

            <code class="ruby">        #   (users.email = &#39;test@example.com&#39;::text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="864">
            

            
              
            

            <code class="ruby">        #   ((role)::text = &#39;admin&#39;::text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="865">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="866">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        columns = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="867">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="868">
            

            
              
            

            <code class="ruby">        # Match table.column references (e.g., users.email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="869">
            
              <span class="hits">22</span>
            

            
              
            

            <code class="ruby">        columns += condition.scan(/(\w+)\.(\w+)/).map { |_table, col| col }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="870">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="871">
            

            
              
            

            <code class="ruby">        # Match standalone column in parens before operator: (column_name = ...) or (column_name &gt;= ...)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="872">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        columns += condition.scan(/\((\w+)\s*[=&lt;&gt;!]/).map(&amp;:first)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="873">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="874">
            

            
              
            

            <code class="ruby">        # Match ((column)::type ...) cast pattern</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="875">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        columns += condition.scan(/\(\((\w+)\)::/).map(&amp;:first)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="876">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="877">
            

            
              
            

            <code class="ruby">        # Match column BETWEEN, column IN, column IS patterns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="878">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        columns += condition.scan(/\((\w+)\s+(?:BETWEEN|IN|IS)\b/i).map(&amp;:first)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="879">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="880">
            

            
              
            

            <code class="ruby">        # Filter out common noise</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="881">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        noise = %w[true false null text integer bigint timestamp date boolean numeric float double].map(&amp;:downcase)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="41" data-linenumber="882">
            
              <span class="hits">41</span>
            

            
              
            

            <code class="ruby">        columns = columns.uniq.reject { |c| noise.include?(c.downcase) || c.length &lt; 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="883">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">        columns.first(5)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="884">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="885">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="886">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="887">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ac0183ac1c8352136409505f9d21f1c9827258cb">
  <div class="header">
    <h3>lib/rails_db_inspector.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>17</b> relevant lines.
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/version&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/engine&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/configuration&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/query_store&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/sql_subscriber&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/explain&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/explain/postgres&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/explain/my_sql&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/explain/sqlite&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;rails_db_inspector/schema_inspector&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Error &lt; StandardError; end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def configuration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="102" data-linenumber="19">
            
              <span class="hits">102</span>
            

            
              
            

            <code class="ruby">      @configuration ||= Configuration.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def configure</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="23">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      yield(configuration)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7493d10db95736c687e1ae7200e48254cf75b8c1">
  <div class="header">
    <h3>lib/rails_db_inspector/configuration.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>11</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Configuration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    attr_accessor :enabled</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    attr_accessor :max_queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    attr_accessor :allow_explain_analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    attr_accessor :show_widget</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="11">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      @enabled = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="12">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      @max_queries = 2_000</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="13">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      @allow_explain_analyze = false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="14">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      @show_widget = true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ea611bdf30362a1ae9ac30f7296f3a892113e8be">
  <div class="header">
    <h3>lib/rails_db_inspector/dev_widget_middleware.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="yellow">
  88.89%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>33</b> relevant lines.
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>18</b> total branches, </span>
          <span class="green"><b>16</b> branches covered</span> and
          <span class="red"><b>2</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class DevWidgetMiddleware</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def initialize(app)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="6">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">      @app = app</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def call(env)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="10">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">      status, headers, response = @app.call(env)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">      # Only inject into HTML responses in development</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="13">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
            

            <code class="ruby">      return [ status, headers, response ] unless injectable?(status, headers, env)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      body = +&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="16">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">      response.each { |part| body &lt;&lt; part }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="17">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      response.close if response.respond_to?(:close)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">      # Find the mount path for the engine</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="20">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      mount_path = find_mount_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="22">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      if body.include?(&quot;&lt;/body&gt;&quot;) &amp;&amp; mount_path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="23">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        widget_html = render_widget(mount_path)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        body.sub!(&quot;&lt;/body&gt;&quot;, &quot;#{widget_html}\n&lt;/body&gt;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        headers[&quot;Content-Length&quot;] = body.bytesize.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="28">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      [ status, headers, [ body ] ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def injectable?(status, headers, env)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="34">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">      return false unless status == 200</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="35">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">      return false unless headers[&quot;Content-Type&quot;]&amp;.include?(&quot;text/html&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">      # Don&#39;t inject into the engine&#39;s own pages</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="38">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      mount_path = find_mount_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="6" data-linenumber="39">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">      return false if mount_path &amp;&amp; env[&quot;PATH_INFO&quot;]&amp;.start_with?(mount_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="41">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def find_mount_path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="45">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      @mount_path ||= begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="46">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">        Rails.application.routes.routes.each do |route|</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="47">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          if route.app.respond_to?(:app) &amp;&amp; route.app.app == RailsDbInspector::Engine</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="48">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">            return &quot;/&quot; + route.path.spec.to_s.sub(/\(.*\)/, &quot;&quot;).gsub(%r{^/|/$}, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="51">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">        nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="55">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def render_widget(mount_path)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="56">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      queries_url = &quot;#{mount_path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="57">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      schema_url = &quot;#{mount_path}/schema&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="59">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby">        &lt;!-- Rails DB Inspector Dev Widget --&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby">        &lt;div id=&quot;rdi-widget&quot; style=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            
              
            

            <code class="ruby">          position: fixed;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            
              
            

            <code class="ruby">          bottom: 16px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby">          right: 16px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            
              
            

            <code class="ruby">          z-index: 99999;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            
              
            

            <code class="ruby">          font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            
              
            

            <code class="ruby">        &quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            
              
            

            <code class="ruby">          &lt;div id=&quot;rdi-panel&quot; style=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby">            display: none;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby">            background: #1f2937;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby">            border-radius: 12px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">            padding: 12px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">            margin-bottom: 8px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby">            box-shadow: 0 10px 25px rgba(0,0,0,0.3);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
            

            <code class="ruby">            min-width: 200px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            
              
            

            <code class="ruby">          &quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby">            &lt;div style=&quot;color: #9ca3af; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; padding: 0 4px;&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby">              DB Inspector</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            
              
            

            <code class="ruby">            &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby">            &lt;a href=&quot;#{queries_url}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot; style=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            
              
            

            <code class="ruby">              display: flex;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            
              
            

            <code class="ruby">              align-items: center;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
            

            <code class="ruby">              padding: 8px 12px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            
              
            

            <code class="ruby">              color: #e5e7eb;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            
              
            

            <code class="ruby">              text-decoration: none;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            
              
            

            <code class="ruby">              font-size: 13px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            
              
            

            <code class="ruby">              font-weight: 500;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby">              border-radius: 8px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">              margin-bottom: 4px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby">              transition: background 0.15s;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            
              
            

            <code class="ruby">            &quot; onmouseover=&quot;this.style.background=&#39;#374151&#39;&quot; onmouseout=&quot;this.style.background=&#39;transparent&#39;&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            
              
            

            <code class="ruby">              &lt;span style=&quot;margin-right: 8px; font-size: 16px;&quot;&gt;&lt;/span&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            
              
            

            <code class="ruby">              Query Monitor</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            
              
            

            <code class="ruby">            &lt;/a&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            
              
            

            <code class="ruby">            &lt;a href=&quot;#{schema_url}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot; style=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            
              
            

            <code class="ruby">              display: flex;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            
              
            

            <code class="ruby">              align-items: center;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            
              
            

            <code class="ruby">              padding: 8px 12px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            
              
            

            <code class="ruby">              color: #e5e7eb;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            
              
            

            <code class="ruby">              text-decoration: none;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            
              
            

            <code class="ruby">              font-size: 13px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            
              
            

            <code class="ruby">              font-weight: 500;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            
              
            

            <code class="ruby">              border-radius: 8px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            
              
            

            <code class="ruby">              transition: background 0.15s;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            
              
            

            <code class="ruby">            &quot; onmouseover=&quot;this.style.background=&#39;#374151&#39;&quot; onmouseout=&quot;this.style.background=&#39;transparent&#39;&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            
              
            

            <code class="ruby">              &lt;span style=&quot;margin-right: 8px; font-size: 16px;&quot;&gt;&lt;/span&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            
              
            

            <code class="ruby">              Schema Visualization</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            
              
            

            <code class="ruby">            &lt;/a&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            
              
            

            <code class="ruby">          &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            
              
            

            <code class="ruby">          &lt;button onclick=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            
              
            

            <code class="ruby">            var panel = document.getElementById(&#39;rdi-panel&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            
              
            

            <code class="ruby">            panel.style.display = panel.style.display === &#39;none&#39; ? &#39;block&#39; : &#39;none&#39;;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby">          &quot; style=&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            
              
            

            <code class="ruby">            width: 48px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            
              
            

            <code class="ruby">            height: 48px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            
              
            

            <code class="ruby">            border-radius: 50%;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby">            background: #2563eb;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            
              
            

            <code class="ruby">            border: none;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            
              
            

            <code class="ruby">            color: white;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            
              
            

            <code class="ruby">            font-size: 20px;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            
              
            

            <code class="ruby">            cursor: pointer;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby">            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            
              
            

            <code class="ruby">            display: flex;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            
              
            

            <code class="ruby">            align-items: center;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            
              
            

            <code class="ruby">            justify-content: center;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            
              
            

            <code class="ruby">            transition: transform 0.15s, box-shadow 0.15s;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            
              
            

            <code class="ruby">            margin-left: auto;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby">          &quot; onmouseover=&quot;this.style.transform=&#39;scale(1.1)&#39;;this.style.boxShadow=&#39;0 6px 16px rgba(37,99,235,0.5)&#39;&quot; onmouseout=&quot;this.style.transform=&#39;scale(1)&#39;;this.style.boxShadow=&#39;0 4px 12px rgba(37,99,235,0.4)&#39;&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            
              
            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            
              
            

            <code class="ruby">          &lt;/button&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            
              
            

            <code class="ruby">        &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            
              
            

            <code class="ruby">        &lt;script&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            
              
            

            <code class="ruby">          document.addEventListener(&#39;click&#39;, function(e) {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            
              
            

            <code class="ruby">            var widget = document.getElementById(&#39;rdi-widget&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            
              
            

            <code class="ruby">            var panel = document.getElementById(&#39;rdi-panel&#39;);</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            
              
            

            <code class="ruby">            if (panel &amp;&amp; widget &amp;&amp; !widget.contains(e.target)) {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            
              
            

            <code class="ruby">              panel.style.display = &#39;none&#39;;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby">          });</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            
              
            

            <code class="ruby">        &lt;/script&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            
              
            

            <code class="ruby">        &lt;!-- /Rails DB Inspector Dev Widget --&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            
              
            

            <code class="ruby">      HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1a9e44810fe1f554cea0c44aebc019e646a8d684">
  <div class="header">
    <h3>lib/rails_db_inspector/engine.rb</h3>
    <h4>
      <span class="red">
  50.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="red">
  0.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>12</b> relevant lines.
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>8</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>8</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require_relative &quot;dev_widget_middleware&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Engine &lt; ::Rails::Engine</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    isolate_namespace RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    initializer &quot;rails_db_inspector.subscribe_sql&quot; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="0" data-linenumber="10">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">      next unless RailsDbInspector.configuration.enabled</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            
              
            

            <code class="ruby">      RailsDbInspector::SqlSubscriber.install!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    initializer &quot;rails_db_inspector.dev_widget&quot; do |app|</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="0" data-linenumber="15">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">      next unless RailsDbInspector.configuration.enabled</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="0" data-linenumber="16">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">      next unless RailsDbInspector.configuration.show_widget</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="0" data-linenumber="17">
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">      next unless Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            
              
            

            <code class="ruby">      app.middleware.use RailsDbInspector::DevWidgetMiddleware</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bd4298eef5a8f0997d3cf62188365097c7a3512a">
  <div class="header">
    <h3>lib/rails_db_inspector/explain.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>6</b> total branches, </span>
          <span class="green"><b>6</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Explain</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class UnsupportedAdapter &lt; StandardError; end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class DangerousQuery &lt; StandardError; end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def self.for_connection(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="9">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      adapter = connection.adapter_name.to_s.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="11">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      case adapter</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /postgres/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        RailsDbInspector::Explain::Postgres.new(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /mysql/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        RailsDbInspector::Explain::MySql.new(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
                <span class="hits" title="when branch hit 1 times">
                  when: 1
                </span>
              
            

            <code class="ruby">      when /sqlite/</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        RailsDbInspector::Explain::Sqlite.new(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        raise UnsupportedAdapter, &quot;Unsupported adapter: #{connection.adapter_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def self.select_only!(sql)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="24">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      return if sql.strip.match?(/\ASELECT\b/i)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      raise DangerousQuery, &quot;Only SELECT is allowed for EXPLAIN ANALYZE by default&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="26844e7350ab7d528c983242fb9b656d5d71f3ea">
  <div class="header">
    <h3>lib/rails_db_inspector/explain/my_sql.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>13</b> relevant lines.
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>2</b> total branches, </span>
          <span class="green"><b>2</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Explain</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class MySql</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def initialize(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="7">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        @connection = connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def explain(sql, analyze: false)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby">        # Strip any existing EXPLAIN prefix to prevent doubling</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="12">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        clean_sql = sql.sub(/\A\s*EXPLAIN\s*(ANALYZE)?\s*/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">        statement =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">          if analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="16">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            RailsDbInspector::Explain.select_only!(clean_sql)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN ANALYZE #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="19">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="22">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">        result = @connection.exec_query(statement)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="24">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">        { adapter: &quot;mysql&quot;, analyze: analyze, columns: result.columns, rows: result.rows }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1ebfc5f22ab7c0dc89fa422c2c79186020722993">
  <div class="header">
    <h3>lib/rails_db_inspector/explain/postgres.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>16</b> relevant lines.
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>4</b> total branches, </span>
          <span class="green"><b>4</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Explain</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class Postgres</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def initialize(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="9">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        @connection = connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def explain(sql, analyze: false)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">        # Strip any existing EXPLAIN prefix to prevent doubling</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="14">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        clean_sql = sql.sub(/\A\s*EXPLAIN\s*(\([^)]*\))?\s*/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">        statement =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="17">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">          if analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="18">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            RailsDbInspector::Explain.select_only!(clean_sql)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN (ANALYZE, BUFFERS, VERBOSE, FORMAT JSON) #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="21">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN (FORMAT JSON) #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="24">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        result = @connection.exec_query(statement)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="25">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        raw = result.rows.dig(0, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="26">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        plan = raw.is_a?(String) ? JSON.parse(raw) : raw</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="28">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        { adapter: &quot;postgres&quot;, analyze: analyze, plan: plan }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="afadfd196b69898674ba600ada8304bccb6f0f89">
  <div class="header">
    <h3>lib/rails_db_inspector/explain/sqlite.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>2</b> total branches, </span>
          <span class="green"><b>2</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class Explain</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    class Sqlite</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def initialize(connection)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="7">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">        @connection = connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      def explain(sql, analyze: false)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby">        # Strip any existing EXPLAIN prefix to prevent doubling</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="12">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        clean_sql = sql.sub(/\A\s*EXPLAIN\s*(QUERY\s+PLAN)?\s*/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">        statement =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">          if analyze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="16">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            RailsDbInspector::Explain.select_only!(clean_sql)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="17">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN QUERY PLAN #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="19">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">            &quot;EXPLAIN QUERY PLAN #{clean_sql}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="22">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        result = @connection.exec_query(statement)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="24">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        plan = result.rows.map do |row|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            &quot;id&quot; =&gt; row[0],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">            &quot;parent&quot; =&gt; row[1],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">            &quot;notused&quot; =&gt; row[2],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">            &quot;detail&quot; =&gt; row[3]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="33">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        { adapter: &quot;sqlite&quot;, analyze: analyze, columns: result.columns, rows: result.rows, plan: plan }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3ba9c5a49c34030a58befb1da20f29939e3c1343">
  <div class="header">
    <h3>lib/rails_db_inspector/query_store.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>42</b> relevant lines.
      <span class="green"><b>42</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>12</b> total branches, </span>
          <span class="green"><b>12</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;singleton&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;securerandom&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &quot;thread&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class QueryStore</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    include Singleton</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    Query = Struct.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">      :id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">      :sql,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">      :name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">      :binds,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">      :duration_ms,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">      :connection_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">      :timestamp,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">      keyword_init: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="23">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">      @mutex = Mutex.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="24">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">      @queries = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="25">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">      @by_id = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def add(sql:, name:, binds:, duration_ms:, connection_id:, timestamp:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="29">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">      q = Query.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">        id: SecureRandom.hex(8),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">        sql: sql,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">        name: name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">        binds: normalize_binds(binds),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">        duration_ms: duration_ms.to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">        connection_id: connection_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">        timestamp: timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="39">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">      @mutex.synchronize do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="40">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">        @queries &lt;&lt; q</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="41">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">        @by_id[q.id] = q</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="42">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">        trim!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="45">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">      q</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="260" data-linenumber="49">
            
              <span class="hits">260</span>
            

            
              
            

            <code class="ruby">      @mutex.synchronize { @queries.dup }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def find(id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="53">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      @mutex.synchronize { @by_id[id] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="56">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def clear!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="57">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">      @mutex.synchronize do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="58">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">        @queries.clear</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="59">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">        @by_id.clear</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="63">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def trim!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="66">
            
              <span class="hits">92</span>
            

            
              
            

            <code class="ruby">      max = RailsDbInspector.configuration.max_queries.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="67">
            
              <span class="hits">92</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 87 times">
                  else: 87
                </span>
              
            

            <code class="ruby">      return if max &lt;= 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="87" data-linenumber="68">
            
              <span class="hits">87</span>
            

            
              
                <span class="hits" title="then branch hit 86 times">
                  then: 86
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      return if @queries.length &lt;= max</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="70">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      drop_count = @queries.length - max</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      dropped = @queries.shift(drop_count)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="72">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      dropped.each { |q| @by_id.delete(q.id) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="75">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def normalize_binds(binds)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="92" data-linenumber="76">
            
              <span class="hits">92</span>
            

            
              
                <span class="hits" title="else branch hit 90 times">
                  else: 90
                </span>
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">      return [] unless binds.is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="90" data-linenumber="78">
            
              <span class="hits">90</span>
            

            
              
            

            <code class="ruby">      binds.map do |b|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="79">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">        if b.respond_to?(:name) &amp;&amp; b.respond_to?(:value_before_type_cast)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="80">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          { name: b.name, value: b.value_before_type_cast, type: b.type&amp;.type }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="81">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        elsif b.is_a?(Array) &amp;&amp; b.length == 2</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="82">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          { name: b[0].to_s, value: b[1], type: nil }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="84">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          { name: nil, value: b.to_s, type: nil }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="672ba5102cbe7570b6ea0a714af34096094c6ccf">
  <div class="header">
    <h3>lib/rails_db_inspector/schema_inspector.rb</h3>
    <h4>
      <span class="green">
  99.7%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="yellow">
  87.5%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>334</b> relevant lines.
      <span class="green"><b>333</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>136</b> total branches, </span>
          <span class="green"><b>119</b> branches covered</span> and
          <span class="red"><b>17</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class SchemaInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    attr_reader :connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def initialize(connection = ActiveRecord::Base.connection)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="113" data-linenumber="8">
            
              <span class="hits">113</span>
            

            
              
            

            <code class="ruby">      @connection = connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    IGNORED_TABLES = %w[schema_migrations ar_internal_metadata].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">    # Returns a hash of table_name =&gt; { columns:, indexes:, foreign_keys: }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="15">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">      tables = connection.tables.sort - IGNORED_TABLES</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="16">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">      schema = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="18">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">      tables.each do |table|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="19">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">        columns = introspect_columns(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="20">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">        indexes = introspect_indexes(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="21">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">        polymorphic_columns = detect_polymorphic_columns(columns)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="22">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">        associations = introspect_associations(table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="24">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">        schema[table] = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">          columns: columns,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">          indexes: indexes,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">          foreign_keys: introspect_foreign_keys(table),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">          primary_key: introspect_primary_key(table),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">          row_count: safe_row_count(table),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">          associations: associations,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">          missing_indexes: detect_missing_indexes(columns, indexes),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">          polymorphic_columns: polymorphic_columns,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">          index_suggestions: detect_index_suggestions(table, columns, indexes, polymorphic_columns, associations)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="37">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">      schema</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">    # Returns relationships between tables for visualization</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def relationships</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="42">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      rels = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="44">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      (connection.tables.sort - IGNORED_TABLES).each do |table|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            
              
            

            <code class="ruby">        # Foreign key-based relationships</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="46">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        if connection.respond_to?(:foreign_keys)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="47">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          connection.foreign_keys(table).each do |fk|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="48">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            rels &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
            

            <code class="ruby">              from_table: table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby">              from_column: fk.column,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
            

            <code class="ruby">              to_table: fk.to_table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            
              
            

            <code class="ruby">              to_column: fk.primary_key || &quot;id&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby">              type: :foreign_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby">        # Convention-based relationships (belongs_to via _id columns)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="59">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        connection.columns(table).each do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="60">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
            

            <code class="ruby">          next unless col.name.end_with?(&quot;_id&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="62">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">          referenced_table = col.name.sub(/_id\z/, &quot;&quot;).pluralize</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="63">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">          next unless connection.tables.include?(referenced_table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            
              
            

            <code class="ruby">          # Skip if already covered by a foreign key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="66">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          already_covered = rels.any? do |r|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="67">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            r[:from_table] == table &amp;&amp; r[:from_column] == col.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="69">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">          next if already_covered</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="71">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">          rels &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">            from_table: table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">            from_column: col.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby">            to_table: referenced_table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
            

            <code class="ruby">            to_column: &quot;id&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            
              
            

            <code class="ruby">            type: :convention</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="81">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      rels</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="84">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect_columns(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="87">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      connection.columns(table).map do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="89">
            
              <span class="hits">43</span>
            

            
              
            

            <code class="ruby">          name: col.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby">          type: col.sql_type,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            
              
            

            <code class="ruby">          nullable: col.null,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            
              
            

            <code class="ruby">          default: col.default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="97">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect_indexes(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="98">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      connection.indexes(table).map do |idx|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="100">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">          name: idx.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            
              
            

            <code class="ruby">          columns: idx.columns,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            
              
            

            <code class="ruby">          unique: idx.unique</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="107">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect_foreign_keys(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="108">
            
              <span class="hits">23</span>
            

            
              
                <span class="hits" title="else branch hit 18 times">
                  else: 18
                </span>
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby">      return [] unless connection.respond_to?(:foreign_keys)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="110">
            
              <span class="hits">18</span>
            

            
              
            

            <code class="ruby">      connection.foreign_keys(table).map do |fk|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="112">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">          column: fk.column,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby">          to_table: fk.to_table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            
              
            

            <code class="ruby">          primary_key: fk.primary_key || &quot;id&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            
              
            

            <code class="ruby">          name: fk.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="120">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect_primary_key(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="121">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      connection.primary_key(table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="124">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def safe_row_count(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="125">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      quoted = connection.quote_table_name(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="126">
            
              <span class="hits">30</span>
            

            
              
            

            <code class="ruby">      result = connection.select_value(&quot;SELECT COUNT(*) FROM #{quoted}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="127">
            
              <span class="hits">29</span>
            

            
              
            

            <code class="ruby">      result.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby">    rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="129">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="132">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def introspect_associations(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="133">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      model = find_model_for_table(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="134">
            
              <span class="hits">26</span>
            

            
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
                <span class="hits" title="then branch hit 22 times">
                  then: 22
                </span>
              
            

            <code class="ruby">      return [] unless model</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="136">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      model.reflect_on_all_associations.map do |assoc|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            
              
            

            <code class="ruby">        target_table = begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="138">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          assoc.klass.table_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby">        rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="140">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="144">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          name: assoc.name.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            
              
            

            <code class="ruby">          macro: assoc.macro.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            
              
            

            <code class="ruby">          target_table: target_table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            
              
            

            <code class="ruby">          foreign_key: assoc.foreign_key.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">          through: assoc.options[:through]&amp;.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            
              
            

            <code class="ruby">    rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="152">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            
              
            

            <code class="ruby">    # Detect _id columns that lack a corresponding index</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="156">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def detect_missing_indexes(columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="157">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      indexed_columns = indexes.flat_map { |idx| idx[:columns] }.to_set</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="159">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="160">
            
              <span class="hits">43</span>
            

            
              
            

            <code class="ruby">        .select { |col| col[:name].end_with?(&quot;_id&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="161">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">        .reject { |col| indexed_columns.include?(col[:name]) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="162">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .map { |col| col[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            
              
            

            <code class="ruby">    # Detect polymorphic column pairs (*_type + *_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="166">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def detect_polymorphic_columns(columns)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="167">
            
              <span class="hits">69</span>
            

            
              
            

            <code class="ruby">      col_names = columns.map { |c| c[:name] }.to_set</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="168">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      polymorphics = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="170">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      columns.each do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="171">
            
              <span class="hits">45</span>
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
                <span class="hits" title="then branch hit 43 times">
                  then: 43
                </span>
              
            

            <code class="ruby">        next unless col[:name].end_with?(&quot;_type&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="173">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        base = col[:name].sub(/_type\z/, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="174">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        id_col = &quot;#{base}_id&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="175">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        next unless col_names.include?(id_col)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="177">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        polymorphics &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            
              
            

            <code class="ruby">          name: base,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            
              
            

            <code class="ruby">          type_column: col[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            
              
            

            <code class="ruby">          id_column: id_col</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="184">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      polymorphics</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            
              
            

            <code class="ruby">    # Build a unified list of index suggestions from multiple strategies</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="188">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def detect_index_suggestions(table, columns, indexes, polymorphic_columns, associations)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="189">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="190">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_polymorphic_composite_indexes(table, indexes, polymorphic_columns))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="191">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_join_table_composite_indexes(table, columns, indexes, associations))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="192">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_query_driven_indexes(table, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="193">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_sti_index(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="194">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_uniqueness_indexes(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="195">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_covering_indexes(table, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="196">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_partial_indexes_for_booleans(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="197">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(detect_redundant_indexes(table, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="198">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_soft_delete_partial_index(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="199">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_timestamp_ordering_indexes(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="200">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      suggestions.concat(suggest_counter_cache_indexes(table, columns, indexes))</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="24" data-linenumber="201">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">      suggestions.uniq { |s| [ s[:reason], s[:columns]&amp;.sort ] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            
              
            

            <code class="ruby">    # Strategy 1: Composite indexes for polymorphic associations [type, id]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="205">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_polymorphic_composite_indexes(table, indexes, polymorphic_columns)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="206">
            
              <span class="hits">29</span>
            

            
              
                <span class="hits" title="then branch hit 23 times">
                  then: 23
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">      return [] if polymorphic_columns.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="208">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      existing_composites = indexes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="209">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .select { |idx| idx[:columns].length &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="210">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .map { |idx| idx[:columns].map(&amp;:to_s) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="212">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      polymorphic_columns.filter_map do |poly|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="213">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        cols = [ poly[:type_column], poly[:id_column] ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            
              
            

            <code class="ruby">        # Skip if a composite index already covers these columns (in any order)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="216">
            
              <span class="hits">11</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        next if existing_composites.any? { |ec| (cols - ec).empty? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="219">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">          columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            
              
            

            <code class="ruby">          reason: :polymorphic,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            
              
            

            <code class="ruby">          message: &quot;Composite index recommended for polymorphic association &#39;#{poly[:name]}&#39;. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            
              
            

            <code class="ruby">                   &quot;Queries on polymorphic associations filter by both type and id.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            
              
            

            <code class="ruby">          sql: &quot;CREATE INDEX index_#{table}_on_#{poly[:name]} ON #{table} (#{cols.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            
              
            

            <code class="ruby">          migration: &quot;add_index :#{table}, [:#{cols.join(&#39;, :&#39;)}]&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            
              
            

            <code class="ruby">    # Strategy 2: Composite indexes for join tables (has_many :through)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="230">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_join_table_composite_indexes(table, columns, indexes, associations)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            
              
            

            <code class="ruby">      # A join table typically has two or more _id columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="126" data-linenumber="232">
            
              <span class="hits">126</span>
            

            
              
            

            <code class="ruby">      id_columns = columns.select { |c| c[:name].end_with?(&quot;_id&quot;) }.map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="233">
            
              <span class="hits">31</span>
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
                <span class="hits" title="then branch hit 26 times">
                  then: 26
                </span>
              
            

            <code class="ruby">      return [] unless id_columns.length &gt;= 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            
              
            

            <code class="ruby">      # Check if this table is used as a :through join table by any association</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="236">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      is_join_table = associations.any? { |a| a[:through].to_s == table } ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            
              
            

            <code class="ruby">                      looks_like_join_table?(table, columns)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="5" data-linenumber="239">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">      return [] unless is_join_table</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="241">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      existing_composites = indexes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="242">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .select { |idx| idx[:columns].length &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="243">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .map { |idx| idx[:columns].map(&amp;:to_s) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="245">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            
              
            

            <code class="ruby">      # Suggest composite index on the pair of FK columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="248">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      fk_pairs = id_columns.combination(2).to_a</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="249">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      fk_pairs.each do |pair|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="250">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        next if existing_composites.any? { |ec| (pair - ec).empty? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="252">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="253">
            

            
              
            

            <code class="ruby">          columns: pair,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            
              
            

            <code class="ruby">          reason: :join_table,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            
              
            

            <code class="ruby">          message: &quot;Composite index recommended for join table &#39;#{table}&#39;. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            
              
            

            <code class="ruby">                   &quot;Queries through this table typically filter on both foreign keys.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            
              
            

            <code class="ruby">          sql: &quot;CREATE INDEX index_#{table}_on_#{pair.join(&#39;_and_&#39;)} ON #{table} (#{pair.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            
              
            

            <code class="ruby">          migration: &quot;add_index :#{table}, [:#{pair.join(&#39;, :&#39;)}]&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            
              
            

            <code class="ruby">        # Also suggest a unique composite if not already present</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="262">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        has_unique = indexes.any? { |idx| idx[:unique] &amp;&amp; (pair - idx[:columns].map(&amp;:to_s)).empty? }</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="5" data-linenumber="263">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby">        unless has_unique</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="264">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            
              
            

            <code class="ruby">            columns: pair,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            
              
            

            <code class="ruby">            reason: :join_table_unique,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            
              
            

            <code class="ruby">            message: &quot;Consider a unique composite index on &#39;#{table}&#39; to prevent duplicate associations.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="268">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE UNIQUE INDEX index_#{table}_on_#{pair.join(&#39;_and_&#39;)}_unique ON #{table} (#{pair.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, [:#{pair.join(&#39;, :&#39;)}], unique: true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="273">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="274">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            
              
            

            <code class="ruby">    # Strategy 3: Query-driven index suggestions from captured queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="278">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_query_driven_indexes(table, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="279">
            
              <span class="hits">31</span>
            

            
              
            

            <code class="ruby">      queries = RailsDbInspector::QueryStore.instance.all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="280">
            
              <span class="hits">31</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 26 times">
                  else: 26
                </span>
              
            

            <code class="ruby">      return [] if queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="282">
            
              <span class="hits">35</span>
            

            
              
            

            <code class="ruby">      existing_indexed = indexes.flat_map { |idx| idx[:columns].map(&amp;:to_s) }.to_set</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="283">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      existing_composites = indexes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="284">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        .select { |idx| idx[:columns].length &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="285">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        .map { |idx| idx[:columns].map(&amp;:to_s) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="287">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      column_usage = Hash.new(0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="288">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      composite_candidates = Hash.new(0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="290">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      queries.each do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="63" data-linenumber="291">
            
              <span class="hits">63</span>
            

            
              
            

            <code class="ruby">        sql = query.sql.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="63" data-linenumber="292">
            
              <span class="hits">63</span>
            

            
              
                <span class="hits" title="else branch hit 49 times">
                  else: 49
                </span>
              
                <span class="hits" title="then branch hit 14 times">
                  then: 14
                </span>
              
            

            <code class="ruby">        next unless references_table?(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="294">
            
              <span class="hits">49</span>
            

            
              
            

            <code class="ruby">        where_columns = extract_where_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="295">
            
              <span class="hits">49</span>
            

            
              
            

            <code class="ruby">        order_columns = extract_order_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            
              
            

            <code class="ruby">        # Track individual column usage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="141" data-linenumber="298">
            
              <span class="hits">141</span>
            

            
              
            

            <code class="ruby">        (where_columns + order_columns).each { |col| column_usage[col] += 1 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="299">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="300">
            

            
              
            

            <code class="ruby">        # Track composite patterns (WHERE + ORDER BY or multi-column WHERE)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="301">
            
              <span class="hits">49</span>
            

            
              
            

            <code class="ruby">        combined = (where_columns + order_columns).uniq</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="302">
            
              <span class="hits">49</span>
            

            
              
                <span class="hits" title="then branch hit 40 times">
                  then: 40
                </span>
              
                <span class="hits" title="else branch hit 9 times">
                  else: 9
                </span>
              
            

            <code class="ruby">        if combined.length &gt;= 2</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="303">
            
              <span class="hits">40</span>
            

            
              
            

            <code class="ruby">          composite_candidates[combined.sort] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="305">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="307">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            
              
            

            <code class="ruby">      # Suggest composite indexes for frequently co-occurring columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="310">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      composite_candidates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="311">
            
              <span class="hits">14</span>
            

            
              
            

            <code class="ruby">        .select { |_cols, count| count &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="312">
            
              <span class="hits">13</span>
            

            
              
            

            <code class="ruby">        .sort_by { |_cols, count| -count }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            

            
              
            

            <code class="ruby">        .first(5)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            
              
            

            <code class="ruby">        .each do |cols, count|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="315">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">          next if existing_composites.any? { |ec| (cols - ec).empty? }</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="22" data-linenumber="316">
            
              <span class="hits">22</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">          next if cols.any? { |c| c.include?(&quot;*&quot;) || c.include?(&quot;(&quot;) } # skip bad parses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="318">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            
              
            

            <code class="ruby">            columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            
              
            

            <code class="ruby">            reason: :query_pattern,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            

            
              
            

            <code class="ruby">            message: &quot;Composite index suggested based on #{count} captured queries &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            
              
            

            <code class="ruby">                     &quot;that filter/sort on these columns together.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE INDEX index_#{table}_on_#{cols.join(&#39;_and_&#39;)} ON #{table} (#{cols.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, [:#{cols.join(&#39;, :&#39;)}]&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="326">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="327">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="328">
            
              <span class="hits">26</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="330">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            
              
            

            <code class="ruby">    # Check if a table name appears in a SQL statement</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="332">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def references_table?(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="106" data-linenumber="333">
            
              <span class="hits">106</span>
            

            
              
            

            <code class="ruby">      sql.match?(/\b#{Regexp.escape(table)}\b/i)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            
              
            

            <code class="ruby">    # Extract column names from WHERE clauses referencing a table</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="337">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def extract_where_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="70" data-linenumber="338">
            
              <span class="hits">70</span>
            

            
              
            

            <code class="ruby">      columns = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            
              
            

            <code class="ruby">      # Only proceed if there&#39;s actually a WHERE clause</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="70" data-linenumber="341">
            
              <span class="hits">70</span>
            

            
              
            

            <code class="ruby">      parts = sql.split(/\bWHERE\b/i, 2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="70" data-linenumber="342">
            
              <span class="hits">70</span>
            

            
              
                <span class="hits" title="then branch hit 19 times">
                  then: 19
                </span>
              
                <span class="hits" title="else branch hit 51 times">
                  else: 51
                </span>
              
            

            <code class="ruby">      return columns if parts.length &lt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="51" data-linenumber="344">
            
              <span class="hits">51</span>
            

            
              
            

            <code class="ruby">      where_section = parts.last.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="51" data-linenumber="345">
            
              <span class="hits">51</span>
            

            
              
            

            <code class="ruby">      where_section = where_section.split(/\b(?:ORDER|GROUP|HAVING|LIMIT|UNION)\b/i, 2).first.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            
              
            

            <code class="ruby">      # table.column or &quot;table&quot;.&quot;column&quot; patterns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="51" data-linenumber="348">
            
              <span class="hits">51</span>
            

            
              
            

            <code class="ruby">      where_section.scan(/(?:#{Regexp.escape(table)}|&quot;#{Regexp.escape(table)}&quot;)\.(?:&quot;?(\w+)&quot;?)/i) do |match|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="349">
            
              <span class="hits">17</span>
            

            
              
            

            <code class="ruby">        columns &lt;&lt; match[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            
              
            

            <code class="ruby">      # Simple column = ? patterns (only if single table query)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="51" data-linenumber="353">
            
              <span class="hits">51</span>
            

            
              
                <span class="hits" title="then branch hit 48 times">
                  then: 48
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      if sql.scan(/\b(?:FROM|JOIN)\b/i).length &lt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="354">
            
              <span class="hits">48</span>
            

            
              
            

            <code class="ruby">        where_section.scan(/\b(\w+)\s*(?:=|!=|&lt;&gt;|&gt;=?|&lt;=?|IN|IS|LIKE|BETWEEN|@@)\s/i) do |match|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="86" data-linenumber="355">
            
              <span class="hits">86</span>
            

            
              
            

            <code class="ruby">          col = match[0]</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="86" data-linenumber="356">
            
              <span class="hits">86</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 86 times">
                  else: 86
                </span>
              
            

            <code class="ruby">          next if sql_keyword?(col)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="86" data-linenumber="357">
            
              <span class="hits">86</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 86 times">
                  else: 86
                </span>
              
            

            <code class="ruby">          next if col.match?(/\A\d+\z/) # skip numeric literals</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="86" data-linenumber="358">
            
              <span class="hits">86</span>
            

            
              
            

            <code class="ruby">          columns &lt;&lt; col</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="361">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="51" data-linenumber="362">
            
              <span class="hits">51</span>
            

            
              
            

            <code class="ruby">      columns.uniq</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="365">
            

            
              
            

            <code class="ruby">    # Extract column names from ORDER BY clauses</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="366">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def extract_order_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="367">
            
              <span class="hits">84</span>
            

            
              
            

            <code class="ruby">      columns = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="368">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            

            
              
            

            <code class="ruby">      # Only proceed if there&#39;s actually an ORDER BY clause</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="370">
            
              <span class="hits">84</span>
            

            
              
            

            <code class="ruby">      parts = sql.split(/\bORDER\s+BY\b/i, 2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="371">
            
              <span class="hits">84</span>
            

            
              
                <span class="hits" title="then branch hit 38 times">
                  then: 38
                </span>
              
                <span class="hits" title="else branch hit 46 times">
                  else: 46
                </span>
              
            

            <code class="ruby">      return columns if parts.length &lt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="373">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      order_section = parts.last.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="374">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      order_section = order_section.split(/\b(?:LIMIT|OFFSET|UNION|HAVING)\b/i, 2).first.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="375">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="376">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      order_section.scan(/(?:#{Regexp.escape(table)}|&quot;#{Regexp.escape(table)}&quot;)\.(?:&quot;?(\w+)&quot;?)/i) do |match|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="41" data-linenumber="377">
            
              <span class="hits">41</span>
            

            
              
            

            <code class="ruby">        columns &lt;&lt; match[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="379">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="46" data-linenumber="380">
            
              <span class="hits">46</span>
            

            
              
                <span class="hits" title="then branch hit 46 times">
                  then: 46
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">      if sql.scan(/\b(?:FROM|JOIN)\b/i).length &lt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="381">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">        order_section.scan(/\b(\w+)\b/) do |match|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="114" data-linenumber="382">
            
              <span class="hits">114</span>
            

            
              
            

            <code class="ruby">          col = match[0]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="114" data-linenumber="383">
            
              <span class="hits">114</span>
            

            
              
                <span class="hits" title="then branch hit 27 times">
                  then: 27
                </span>
              
                <span class="hits" title="else branch hit 87 times">
                  else: 87
                </span>
              
            

            <code class="ruby">          next if sql_keyword?(col)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="87" data-linenumber="384">
            
              <span class="hits">87</span>
            

            
              
                <span class="hits" title="then branch hit 41 times">
                  then: 41
                </span>
              
                <span class="hits" title="else branch hit 46 times">
                  else: 46
                </span>
              
            

            <code class="ruby">          next if col == table</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="385">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">          columns &lt;&lt; col</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="386">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="387">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="389">
            
              <span class="hits">46</span>
            

            
              
            

            <code class="ruby">      columns.uniq</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="392">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    SQL_KEYWORDS = %w[</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            
              
            

            <code class="ruby">      AND OR NOT NULL TRUE FALSE SELECT FROM WHERE JOIN ON IN IS LIKE BETWEEN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="394">
            

            
              
            

            <code class="ruby">      AS BY ASC DESC NULLS FIRST LAST GROUP ORDER HAVING LIMIT OFFSET UNION</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            
              
            

            <code class="ruby">      INSERT UPDATE DELETE SET VALUES INTO TABLE CREATE INDEX DISTINCT COUNT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            
              
            

            <code class="ruby">      SUM AVG MIN MAX CASE WHEN THEN ELSE END EXISTS ALL ANY INNER OUTER</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            
              
            

            <code class="ruby">      LEFT RIGHT CROSS FULL NATURAL USING WITH RECURSIVE</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            

            
              
            

            <code class="ruby">    ].to_set.freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="399">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="400">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def sql_keyword?(word)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="200" data-linenumber="401">
            
              <span class="hits">200</span>
            

            
              
            

            <code class="ruby">      SQL_KEYWORDS.include?(word.upcase)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="402">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="403">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            
              
            

            <code class="ruby">    # Heuristic: does this table look like a join table?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="405">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def looks_like_join_table?(table, columns)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="38" data-linenumber="406">
            
              <span class="hits">38</span>
            

            
              
            

            <code class="ruby">      col_names = columns.map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="38" data-linenumber="407">
            
              <span class="hits">38</span>
            

            
              
            

            <code class="ruby">      id_cols = col_names.select { |n| n.end_with?(&quot;_id&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="409">
            

            
              
            

            <code class="ruby">      # Join tables typically have 2+ FK columns and few other columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="410">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      non_meta = col_names - %w[id created_at updated_at] - id_cols</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="411">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      id_cols.length &gt;= 2 &amp;&amp; non_meta.length &lt;= 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            
              
            

            <code class="ruby">    # Strategy 4: STI (Single Table Inheritance)  index on `type` column</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="415">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_sti_index(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="416">
            
              <span class="hits">82</span>
            

            
              
            

            <code class="ruby">      type_col = columns.find { |c| c[:name] == &quot;type&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="417">
            
              <span class="hits">28</span>
            

            
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
                <span class="hits" title="then branch hit 25 times">
                  then: 25
                </span>
              
            

            <code class="ruby">      return [] unless type_col</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="419">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">      indexed = indexes.any? { |idx| idx[:columns].include?(&quot;type&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="420">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      return [] if indexed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="421">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="422">
            

            
              
            

            <code class="ruby">      [ {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="423">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        columns: [ &quot;type&quot; ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            

            
              
            

            <code class="ruby">        reason: :sti,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="425">
            

            
              
            

            <code class="ruby">        message: &quot;Index recommended on &#39;type&#39; column for Single Table Inheritance. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            

            
              
            

            <code class="ruby">                 &quot;Rails always filters by type in STI queries.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="427">
            

            
              
            

            <code class="ruby">        sql: &quot;CREATE INDEX index_#{table}_on_type ON #{table} (type);&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="428">
            

            
              
            

            <code class="ruby">        migration: &quot;add_index :#{table}, :type&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="429">
            

            
              
            

            <code class="ruby">      } ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="430">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="431">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            

            
              
            

            <code class="ruby">    # Strategy 5: Uniqueness validations without a matching unique index</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="433">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_uniqueness_indexes(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="434">
            
              <span class="hits">29</span>
            

            
              
            

            <code class="ruby">      model = find_model_for_table(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="435">
            
              <span class="hits">29</span>
            

            
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
                <span class="hits" title="then branch hit 25 times">
                  then: 25
                </span>
              
            

            <code class="ruby">      return [] unless model</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="436">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="437">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="439">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">      unique_validators = model.validators.select { |v| v.is_a?(ActiveRecord::Validations::UniquenessValidator) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="440">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      unique_validators.each do |validator|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="441">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        attrs = validator.attributes.map(&amp;:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="442">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        scope = Array(validator.options[:scope]).map(&amp;:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="443">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        cols = (scope + attrs).uniq</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="444">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="445">
            

            
              
            

            <code class="ruby">        # Check if a unique index already covers these columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="446">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        has_unique_index = indexes.any? do |idx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="447">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          idx[:unique] &amp;&amp; (cols - idx[:columns].map(&amp;:to_s)).empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="448">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="449">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        next if has_unique_index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="450">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="451">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        col_names = columns.map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="5" data-linenumber="452">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">        next unless cols.all? { |c| col_names.include?(c) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="454">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        if cols.length == 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="455">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="456">
            

            
              
            

            <code class="ruby">            columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="457">
            

            
              
            

            <code class="ruby">            reason: :uniqueness,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            
              
            

            <code class="ruby">            message: &quot;Unique index recommended for validates_uniqueness_of :#{attrs.first}. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            

            
              
            

            <code class="ruby">                     &quot;Without a database-level unique index, there is a race condition.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="460">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE UNIQUE INDEX index_#{table}_on_#{cols.first} ON #{table} (#{cols.first});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="461">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, :#{cols.first}, unique: true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="463">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="464">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="465">
            

            
              
            

            <code class="ruby">            columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="466">
            

            
              
            

            <code class="ruby">            reason: :uniqueness,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            
              
            

            <code class="ruby">            message: &quot;Unique composite index recommended for validates_uniqueness_of :#{attrs.first} &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            

            
              
            

            <code class="ruby">                     &quot;scoped to [:#{scope.join(&#39;, :&#39;)}]. Without it, there is a race condition.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="469">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE UNIQUE INDEX index_#{table}_on_#{cols.join(&#39;_and_&#39;)} ON #{table} (#{cols.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="470">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, [:#{cols.join(&#39;, :&#39;)}], unique: true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="472">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="473">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="474">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="475">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="476">
            

            
              
            

            <code class="ruby">    rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            
              
            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="480">
            

            
              
            

            <code class="ruby">    # Strategy 6: Covering indexes (WHERE col + ORDER BY col)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="481">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_covering_indexes(table, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="482">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">      queries = RailsDbInspector::QueryStore.instance.all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="483">
            
              <span class="hits">28</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 23 times">
                  else: 23
                </span>
              
            

            <code class="ruby">      return [] if queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="485">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      existing_composites = indexes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="486">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        .select { |idx| idx[:columns].length &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="487">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        .map { |idx| idx[:columns].map(&amp;:to_s) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="488">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="489">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      covering_candidates = Hash.new(0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="490">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="491">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      queries.each do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="492">
            
              <span class="hits">27</span>
            

            
              
            

            <code class="ruby">        sql = query.sql.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="493">
            
              <span class="hits">27</span>
            

            
              
                <span class="hits" title="else branch hit 16 times">
                  else: 16
                </span>
              
                <span class="hits" title="then branch hit 11 times">
                  then: 11
                </span>
              
            

            <code class="ruby">        next unless references_table?(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="494">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="495">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">        where_cols = extract_where_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="496">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">        order_cols = extract_order_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="497">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="498">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 9 times">
                  then: 9
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        next if where_cols.empty? || order_cols.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="499">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="500">
            

            
              
            

            <code class="ruby">        # Covering index: WHERE columns first, then ORDER BY columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="501">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        covering = (where_cols + order_cols).uniq</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="502">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        next if covering.length &lt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="21" data-linenumber="503">
            
              <span class="hits">21</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        next if covering.any? { |c| c.include?(&quot;*&quot;) || c.include?(&quot;(&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="504">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="505">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        covering_candidates[covering] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="507">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="508">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="509">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="510">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      covering_candidates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="511">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        .select { |_cols, count| count &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="512">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        .sort_by { |_cols, count| -count }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="513">
            

            
              
            

            <code class="ruby">        .first(3)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="514">
            

            
              
            

            <code class="ruby">        .each do |cols, count|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            
              
            

            <code class="ruby">          # Skip if already covered by an existing composite</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="516">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          next if existing_composites.any? { |ec| ec.first(cols.length) == cols }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="517">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="518">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="519">
            

            
              
            

            <code class="ruby">            columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="520">
            

            
              
            

            <code class="ruby">            reason: :covering,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="521">
            

            
              
            

            <code class="ruby">            message: &quot;Covering index suggested based on #{count} queries with WHERE + ORDER BY. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="522">
            

            
              
            

            <code class="ruby">                     &quot;Column order matters: filter columns first, then sort columns.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="523">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE INDEX index_#{table}_on_#{cols.join(&#39;_and_&#39;)} ON #{table} (#{cols.join(&#39;, &#39;)});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="524">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, [:#{cols.join(&#39;, :&#39;)}]&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="525">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="526">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="527">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="528">
            
              <span class="hits">23</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="529">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="530">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="531">
            

            
              
            

            <code class="ruby">    # Strategy 7: Partial indexes for boolean columns with skewed data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="532">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_partial_indexes_for_booleans(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="97" data-linenumber="533">
            
              <span class="hits">97</span>
            

            
              
            

            <code class="ruby">      bool_columns = columns.select { |c| c[:type].to_s.match?(/bool/i) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="534">
            
              <span class="hits">33</span>
            

            
              
                <span class="hits" title="then branch hit 25 times">
                  then: 25
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">      return [] if bool_columns.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="535">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="536">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      row_count = safe_row_count(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="537">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
            

            <code class="ruby">      return [] unless row_count &amp;&amp; row_count &gt; 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="538">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="539">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="540">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="541">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      bool_columns.each do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="542">
            

            
              
            

            <code class="ruby">        # Skip if there&#39;s already an index involving this column</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="543">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        already_indexed = indexes.any? { |idx| idx[:columns].include?(col[:name]) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="544">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
            

            <code class="ruby">        next if already_indexed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="545">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="546">
            

            
              
            

            <code class="ruby">        # Check distribution if possible</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="547">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        true_count = safe_bool_count(table, col[:name], true)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="548">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        false_count = safe_bool_count(table, col[:name], false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="5" data-linenumber="549">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="else branch hit 5 times">
                  else: 5
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">        next unless true_count &amp;&amp; false_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="550">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="551">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        total = true_count + false_count</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="552">
            
              <span class="hits">5</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        next if total == 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="553">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="554">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        minority_value = true_count &lt;= false_count ? true : false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="555">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        minority_count = [ true_count, false_count ].min</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="556">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        minority_pct = (minority_count.to_f / total * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="557">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="558">
            

            
              
            

            <code class="ruby">        # Only suggest if data is skewed (minority &lt; 30%)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="559">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">        next unless minority_pct &lt; 30</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="560">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="561">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="562">
            

            
              
            

            <code class="ruby">          columns: [ col[:name] ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="563">
            

            
              
            

            <code class="ruby">          reason: :partial_boolean,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="564">
            

            
              
            

            <code class="ruby">          message: &quot;Partial index suggested on &#39;#{col[:name]}&#39; (#{minority_pct}% are #{minority_value}). &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="565">
            

            
              
            

            <code class="ruby">                   &quot;A partial index on the minority value is more efficient than a full index.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            

            
              
            

            <code class="ruby">          sql: &quot;CREATE INDEX index_#{table}_on_#{col[:name]}_#{minority_value} ON #{table} (#{col[:name]}) &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="567">
            

            
              
            

            <code class="ruby">               &quot;WHERE #{col[:name]} = #{minority_value};&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="568">
            

            
              
            

            <code class="ruby">          migration: &quot;add_index :#{table}, :#{col[:name]}, where: \&quot;#{col[:name]} = #{minority_value}\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="570">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="571">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="572">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="573">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="574">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="575">
            

            
              
            

            <code class="ruby">    # Strategy 8: Detect redundant/duplicate indexes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="576">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def detect_redundant_indexes(table, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="577">
            
              <span class="hits">29</span>
            

            
              
                <span class="hits" title="then branch hit 25 times">
                  then: 25
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      return [] if indexes.length &lt; 2</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="578">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="579">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="580">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="581">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      indexes.each do |idx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="582">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        cols = idx[:columns].map(&amp;:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="8" data-linenumber="583">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">        next if cols.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="584">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">        next if idx[:unique] # unique indexes serve a different purpose</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="585">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="586">
            

            
              
            

            <code class="ruby">        # Check if another index has this one as a prefix</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="587">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        indexes.each do |other|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="588">
            
              <span class="hits">14</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
            

            <code class="ruby">          next if other[:name] == idx[:name]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="589">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="590">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">          other_cols = other[:columns].map(&amp;:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="591">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">          next if other_cols.length &lt;= cols.length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="592">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="593">
            

            
              
            

            <code class="ruby">          # idx is redundant if its columns are a prefix of other&#39;s columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="594">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          if other_cols.first(cols.length) == cols</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="595">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="596">
            

            
              
            

            <code class="ruby">              columns: cols,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="597">
            

            
              
            

            <code class="ruby">              reason: :redundant,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="598">
            

            
              
            

            <code class="ruby">              redundant_index: idx[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="599">
            

            
              
            

            <code class="ruby">              covered_by: other[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="600">
            

            
              
            

            <code class="ruby">              message: &quot;Index &#39;#{idx[:name]}&#39; (#{cols.join(&#39;, &#39;)}) is redundant  &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="601">
            

            
              
            

            <code class="ruby">                       &quot;it&#39;s a prefix of &#39;#{other[:name]}&#39; (#{other_cols.join(&#39;, &#39;)}). &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="602">
            

            
              
            

            <code class="ruby">                       &quot;Consider removing it to improve write performance.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="603">
            

            
              
            

            <code class="ruby">              sql: &quot;DROP INDEX #{idx[:name]};&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="604">
            

            
              
            

            <code class="ruby">              migration: &quot;remove_index :#{table}, name: :#{idx[:name]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="605">
            

            
              
            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="606">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            break # Only report once per redundant index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="607">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="609">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="610">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="611">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="612">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="613">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="614">
            

            
              
            

            <code class="ruby">    # Strategy 9: Partial index for soft-delete columns (deleted_at, discarded_at, archived_at)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="615">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    SOFT_DELETE_COLUMNS = %w[deleted_at discarded_at archived_at].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="616">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="617">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_soft_delete_partial_index(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="93" data-linenumber="618">
            
              <span class="hits">93</span>
            

            
              
            

            <code class="ruby">      col_names = columns.map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="115" data-linenumber="619">
            
              <span class="hits">115</span>
            

            
              
            

            <code class="ruby">      soft_delete_col = SOFT_DELETE_COLUMNS.find { |sd| col_names.include?(sd) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="620">
            
              <span class="hits">31</span>
            

            
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
                <span class="hits" title="then branch hit 25 times">
                  then: 25
                </span>
              
            

            <code class="ruby">      return [] unless soft_delete_col</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="621">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="622">
            

            
              
            

            <code class="ruby">      # Check if there&#39;s already a partial index or any index on this column</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="623">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      already_indexed = indexes.any? { |idx| idx[:columns].include?(soft_delete_col) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="624">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      return [] if already_indexed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="625">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="626">
            

            
              
            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="627">
            

            
              
            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="628">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">          columns: [ soft_delete_col ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="629">
            

            
              
            

            <code class="ruby">          reason: :soft_delete,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="630">
            

            
              
            

            <code class="ruby">          message: &quot;Partial index suggested on &#39;#{table}&#39; for active records. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="631">
            

            
              
            

            <code class="ruby">                   &quot;Most queries filter out soft-deleted rows  a partial index on &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="632">
            

            
              
            

            <code class="ruby">                   &quot;WHERE #{soft_delete_col} IS NULL is much smaller and faster.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="633">
            

            
              
            

            <code class="ruby">          sql: &quot;CREATE INDEX index_#{table}_active ON #{table} (id) WHERE #{soft_delete_col} IS NULL;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="634">
            

            
              
            

            <code class="ruby">          migration: &quot;add_index :#{table}, :id, where: \&quot;#{soft_delete_col} IS NULL\&quot;, name: :index_#{table}_active&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="635">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="636">
            

            
              
            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="637">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="638">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="639">
            

            
              
            

            <code class="ruby">    # Strategy 10: Timestamp ordering indexes (created_at / updated_at used in ORDER BY)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="640">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_timestamp_ordering_indexes(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="641">
            
              <span class="hits">29</span>
            

            
              
            

            <code class="ruby">      queries = RailsDbInspector::QueryStore.instance.all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="642">
            
              <span class="hits">29</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 24 times">
                  else: 24
                </span>
              
            

            <code class="ruby">      return [] if queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="643">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="644">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      timestamp_cols = columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="645">
            
              <span class="hits">50</span>
            

            
              
            

            <code class="ruby">        .select { |c| %w[created_at updated_at].include?(c[:name]) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="646">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        .map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="647">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 21 times">
                  then: 21
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      return [] if timestamp_cols.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="648">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="649">
            

            
              
            

            <code class="ruby">      # Count how often each timestamp column appears in ORDER BY for this table</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="650">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      order_usage = Hash.new(0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="651">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="652">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      queries.each do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="653">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        sql = query.sql.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="654">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">        next unless references_table?(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="655">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="656">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        order_cols = extract_order_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="657">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        order_cols.each do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="658">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          order_usage[col] += 1 if timestamp_cols.include?(col)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="659">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="660">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="661">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="662">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="663">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="664">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      order_usage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="665">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        .select { |_col, count| count &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="666">
            

            
              
            

            <code class="ruby">        .each do |col, count|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="667">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          already_indexed = indexes.any? { |idx| idx[:columns].first == col }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="668">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          next if already_indexed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="669">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="670">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="671">
            

            
              
            

            <code class="ruby">            columns: [ col ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="672">
            

            
              
            

            <code class="ruby">            reason: :timestamp_order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="673">
            

            
              
            

            <code class="ruby">            message: &quot;Index suggested on &#39;#{col}&#39;  used in ORDER BY across #{count} queries. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="674">
            

            
              
            

            <code class="ruby">                     &quot;Pagination and feed-style queries benefit significantly from this index.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="675">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE INDEX index_#{table}_on_#{col} ON #{table} (#{col});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="676">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, :#{col}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="677">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="678">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="679">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="680">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="681">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="682">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="683">
            

            
              
            

            <code class="ruby">    # Strategy 11: Counter cache columns used in ORDER BY</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="684">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def suggest_counter_cache_indexes(table, columns, indexes)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="685">
            
              <span class="hits">29</span>
            

            
              
            

            <code class="ruby">      queries = RailsDbInspector::QueryStore.instance.all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="686">
            
              <span class="hits">29</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
                <span class="hits" title="else branch hit 24 times">
                  else: 24
                </span>
              
            

            <code class="ruby">      return [] if queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="687">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="688">
            
              <span class="hits">24</span>
            

            
              
            

            <code class="ruby">      count_cols = columns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="50" data-linenumber="689">
            
              <span class="hits">50</span>
            

            
              
            

            <code class="ruby">        .select { |c| c[:name].end_with?(&quot;_count&quot;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="690">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        .map { |c| c[:name] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="691">
            
              <span class="hits">24</span>
            

            
              
                <span class="hits" title="then branch hit 21 times">
                  then: 21
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      return [] if count_cols.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="692">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="693">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      order_usage = Hash.new(0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="694">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="695">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      queries.each do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="696">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        sql = query.sql.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="697">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">        next unless references_table?(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="698">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="699">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        order_cols = extract_order_columns(sql, table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="700">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        order_cols.each do |col|</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="7" data-linenumber="701">
            
              <span class="hits">7</span>
            

            
              
                <span class="hits" title="then branch hit 7 times">
                  then: 7
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">          order_usage[col] += 1 if count_cols.include?(col)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="702">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="703">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="704">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="705">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      suggestions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="706">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="707">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      order_usage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="708">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">        .select { |_col, count| count &gt;= 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="709">
            

            
              
            

            <code class="ruby">        .each do |col, count|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="710">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">          already_indexed = indexes.any? { |idx| idx[:columns].include?(col) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="711">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          next if already_indexed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="712">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="713">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          suggestions &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="714">
            

            
              
            

            <code class="ruby">            columns: [ col ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="715">
            

            
              
            

            <code class="ruby">            reason: :counter_cache,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="716">
            

            
              
            

            <code class="ruby">            message: &quot;Index suggested on &#39;#{col}&#39;  used for sorting in #{count} queries. &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="717">
            

            
              
            

            <code class="ruby">                     &quot;Counter cache columns used in leaderboard/ranking queries benefit from an index.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="718">
            

            
              
            

            <code class="ruby">            sql: &quot;CREATE INDEX index_#{table}_on_#{col} ON #{table} (#{col});&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="719">
            

            
              
            

            <code class="ruby">            migration: &quot;add_index :#{table}, :#{col}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="720">
            

            
              
            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="721">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="722">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="723">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      suggestions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="724">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="725">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="726">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def safe_bool_count(table, column, value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="727">
            
              <span class="hits">12</span>
            

            
              
            

            <code class="ruby">      quoted_table = connection.quote_table_name(table)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="728">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      quoted_col = connection.quote_column_name(column)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="729">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      result = connection.select_value(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="730">
            

            
              
            

            <code class="ruby">        &quot;SELECT COUNT(*) FROM #{quoted_table} WHERE #{quoted_col} = #{value}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="731">
            

            
              
            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="732">
            
              <span class="hits">11</span>
            

            
              
            

            <code class="ruby">      result.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="733">
            

            
              
            

            <code class="ruby">    rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="734">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="735">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="736">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="737">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def find_model_for_table(table)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="738">
            

            
              
            

            <code class="ruby">      # Force-load all models so descendants are populated</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="58" data-linenumber="739">
            
              <span class="hits">58</span>
            

            
              
            

            <code class="ruby">      eager_load_models!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="740">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="55" data-linenumber="741">
            
              <span class="hits">55</span>
            

            
              
            

            <code class="ruby">      ActiveRecord::Base.descendants.detect do |klass|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="742">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">        klass.table_name == table &amp;&amp; !klass.abstract_class?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="743">
            

            
              
            

            <code class="ruby">      rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="744">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="745">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="746">
            

            
              
            

            <code class="ruby">    rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="747">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="748">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="749">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="750">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def eager_load_models!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="63" data-linenumber="751">
            
              <span class="hits">63</span>
            

            
              
                <span class="hits" title="then branch hit 33 times">
                  then: 33
                </span>
              
                <span class="hits" title="else branch hit 30 times">
                  else: 30
                </span>
              
            

            <code class="ruby">      return if @models_loaded</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="752">
            
              <span class="hits">30</span>
            

            
              
            

            <code class="ruby">      @models_loaded = true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="753">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="754">
            

            
              
            

            <code class="ruby">      # Use Zeitwerk autoloader to load all models</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="755">
            
              <span class="hits">30</span>
            

            
              
            

            <code class="ruby">      model_paths = Rails.application.config.paths[&quot;app/models&quot;].to_a</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="756">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">      model_paths.each do |dir|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="757">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        Dir.glob(&quot;#{dir}/**/*.rb&quot;).sort.each do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="758">
            

            
              
            

            <code class="ruby">          begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="759">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">            require file</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="760">
            

            
              
            

            <code class="ruby">          rescue StandardError, LoadError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="761">
            

            
              
            

            <code class="ruby">            # Skip models that fail to load</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="762">
            

            
              
            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="763">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="764">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="765">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="766">
            

            
              
            

            <code class="ruby">      # Fallback: eager load the whole app if no descendants found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="767">
            
              <span class="hits">37</span>
            

            
              
                <span class="hits" title="then branch hit 19 times">
                  then: 19
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">      if ActiveRecord::Base.descendants.reject { |k| k.abstract_class? rescue true }.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="768">
            

            
              
            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="769">
            
              <span class="hits">19</span>
            

            
              
            

            <code class="ruby">          Rails.application.eager_load!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="770">
            

            
              
            

            <code class="ruby">        rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="771">
            

            
              
            

            <code class="ruby">          # ignore</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="772">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="773">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="774">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="775">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="776">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="33c235cfa4091352ae218ce1f320386b73ca9125">
  <div class="header">
    <h3>lib/rails_db_inspector/sql_subscriber.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  92.86%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>19</b> relevant lines.
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>14</b> total branches, </span>
          <span class="green"><b>13</b> branches covered</span> and
          <span class="red"><b>1</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            
              
            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module RailsDbInspector</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  class SqlSubscriber</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    IGNORED_NAMES = [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby">      &quot;SCHEMA&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby">      &quot;TRANSACTION&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">      &quot;ActiveRecord::SchemaMigration Load&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby">      &quot;ActiveRecord::InternalMetadata Load&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">    ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    def self.install!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="13">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">      return if @installed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="15">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      @installed = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      RailsDbInspector::QueryStore.instance</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="18">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      ActiveSupport::Notifications.subscribe(&quot;sql.active_record&quot;) do |*args|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="19">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        event = ActiveSupport::Notifications::Event.new(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="20">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        payload = event.payload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="22">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        name = payload[:name].to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="23">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        sql  = payload[:sql].to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="25">
            
              <span class="hits">9</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">        next if sql.strip.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="26">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 2 times">
                  then: 2
                </span>
              
                <span class="hits" title="else branch hit 6 times">
                  else: 6
                </span>
              
            

            <code class="ruby">        next if IGNORED_NAMES.include?(name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="27">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
                <span class="hits" title="else branch hit 3 times">
                  else: 3
                </span>
              
            

            <code class="ruby">        next if sql =~ /\A(?:BEGIN|COMMIT|ROLLBACK)\b/i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="28">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        next if sql =~ /\A\s*EXPLAIN\b/i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="29">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        next if payload[:cached]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        RailsDbInspector::QueryStore.instance.add(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">          sql: sql,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">          name: name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">          binds: payload[:binds],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">          duration_ms: event.duration,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">          connection_id: payload[:connection_id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">          timestamp: (event.time.is_a?(Time) ? event.time : Time.at(event.time.to_f))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
